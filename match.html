
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Match Simulator — Intense Live Match</title>

  <!-- NO EXTERNAL CDN — EVERYTHING EMBEDDED -->
  <style>
    /* === TAILWIND-LIKE STYLES (NO CDN) === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      background: radial-gradient(circle at center, #050606 0%, #000 100%); 
      color: #e6eef0; 
      min-height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 1.5rem;
    }
    .container { 
      width: 100%; max-width: 90rem; 
      background: rgba(15,15,15,0.88); 
      backdrop-filter: blur(8px); 
      border: 1px solid rgba(0,255,120,0.06); 
      border-radius: 1rem; 
      padding: 1.5rem 2.5rem; 
    }
    h1 { font-size: 1.875rem; font-weight: 800; color: #86efac; }
    input { 
      background: #071214; border: 1px solid #374151; color: white; 
      padding: 0.5rem; border-radius: 0.5rem; width: 11rem; font-size: 0.875rem;
    }
    .btn { 
      padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; 
      cursor: pointer; transition: all 0.2s;
    }
    .btn-green { background: #16a34a; color: white; }
    .btn-green:hover { background: #15803d; }
    .btn-green:disabled { opacity: 0.5; cursor: not-allowed; }
    .tick { 
      width: 2.25rem; height: 2.25rem; border-radius: 0.5rem; 
      display: flex; align-items: center; justify-content: center; 
      cursor: pointer; font-size: 1.25rem;
    }
    .tick-on { background: #064e2c; border: 1px solid #22c55e60; color: white; }
    .player-row { 
      background: #071413; padding: 0.5rem; border-radius: 0.5rem; 
      border: 1px solid #374151; display: flex; justify-content: space-between; 
      font-size: 0.875rem; margin-bottom: 0.5rem;
    }
    .overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); 
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    .modal { 
      background: #08110e; border: 1px solid #22c55e40; border-radius: 1rem; 
      padding: 1.5rem; width: 95%; max-width: 90rem; position: relative;
    }
    .pitch { 
      background: linear-gradient(180deg, #0b3e23, #063018); 
      border-radius: 0.5rem; height: 26rem; position: relative; overflow: hidden;
    }
    .ball { 
      width: 1.75rem; height: 1.75rem; background: white; 
      border-radius: 50%; position: absolute; left: 50%; top: 50%; 
      transform: translate(-50%, -50%); display: flex; 
      align-items: center; justify-content: center; font-weight: bold; 
      color: #166534; font-size: 0.75rem;
    }
    .player-pill { 
      position: absolute; background: rgba(34,197,94,0.1); 
      color: #a7f3d0; border: 1px solid rgba(34,197,94,0.2); 
      padding: 0.25rem 0.75rem; border-radius: 1rem; 
      font-size: 0.75rem; font-weight: bold; cursor: grab; 
      transform: translate(-50%, -50%);
    }
    .player-pill.b { background: rgba(239,68,68,0.1); color: #fecaca; border-color: rgba(239,68,68,0.2); }
    .goal-flash { animation: flash 1.6s ease; }
    @keyframes flash { 0%,100% { opacity:0; transform:translateY(-10px) } 20%,80% { opacity:1; transform:translateY(0) } }
    .hidden { display: none !important; }
    .scroll { max-height: 56vh; overflow-y: auto; padding: 0.5rem; }
    .scroll::-webkit-scrollbar { width: 8px; }
    .scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 999px; }
    .sub-modal { 
      background: #07110f; border: 1px solid #22c55e40; padding: 1.5rem; 
      border-radius: 1rem; width: 90%; max-width: 32rem;
    }
    select { 
      background: #071214; border: 1px solid #374151; color: white; 
      padding: 0.5rem; border-radius: 0.5rem; width: 100%; margin-bottom: 0.75rem;
    }
  </style>
</head>
<body>

  <div class="container">
    <div style="display:flex; flex-direction:column; gap:1.5rem; align-items:center;">
      <h1>AI Match Simulator — Intense Live Match</h1>

      <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center;">
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <input id="teamAName" placeholder="Team A name" />
          <div id="tickA" class="tick" style="background:#1f2937; border:1px solid #374151; color:#9ca3af;" title="Generate squad">Check</div>
        </div>
        <div style="display:flex; gap:0.5rem; align-items:center;">
          <input id="teamBName" placeholder="Team B name" />
          <div id="tickB" class="tick" style="background:#1f2937; border:1px solid #374151; color:#9ca3af;" title="Generate squad">Check</div>
        </div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-top:1.5rem;">
      <div>
        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
          <h2 id="teamATitle" style="font-size:1.125rem; font-weight:600; color:#86efac;">Team A</h2>
          <div style="font-size:0.75rem; color:#9ca3af;">11 starters · 4 subs</div>
        </div>
        <div id="players-A" class="scroll" style="background:#00000033; border:1px solid #374151; border-radius:0.5rem;"></div>
      </div>
      <div>
        <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
          <h2 id="teamBTitle" style="font-size:1.125rem; font-weight:600; color:#86efac;">Team B</h2>
          <div style="font-size:0.75rem; color:#9ca3af;">11 starters · 4 subs</div>
        </div>
        <div id="players-B" class="scroll" style="background:#00000033; border:1px solid #374151; border-radius:0.5rem;"></div>
      </div>
    </div>

    <div style="margin-top:1.5rem; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-size:0.875rem; color:#9ca3af;">
        Type name → click Checkmark → both green → <span style="color:white; font-weight:600;">Start Match</span>
      </div>
      <button id="startBtn" class="btn btn-green" disabled>Start Match Flow</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" class="overlay hidden">
    <div style="background:#07110f; border:1px solid #22c55e40; padding:1.5rem; border-radius:1rem; text-align:center; width:90%; max-width:24rem;">
      <div style="font-size:3rem; animation:spin 1s linear infinite;">Soccer Ball</div>
      <div id="loadText" style="margin:1rem 0; font-weight:600;">Preparing teams…</div>
      <div id="countdown" style="font-size:3.75rem; font-weight:800; color:#86efac;">5</div>
    </div>
  </div>

  <!-- Match Modal -->
  <div id="matchModal" class="overlay hidden">
    <div class="modal">
      <button id="closeBtn" style="position:absolute; top:0.75rem; right:0.75rem; color:#9ca3af; font-size:1.5rem;">×</button>

      <div style="display:flex; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; gap:1rem;">
        <div style="display:flex; gap:1rem; align-items:center;">
          <div style="font-size:0.75rem; color:#9ca3af;">Time</div>
          <div id="time" style="font-size:1.25rem; font-weight:bold;">0'</div>
        </div>
        <div style="text-align:center;">
          <div style="font-size:1.875rem; font-weight:800;">
            <span id="mTeamA" style="color:#86efac;">Team A</span>
            <span id="scoreA" style="color:#86efac; margin:0 0.5rem;">0</span>
            <span style="color:#9ca3af;">—</span>
            <span id="scoreB" style="color:#fca5a5; margin:0 0.5rem;">0</span>
            <span id="mTeamB" style="color:#fca5a5;">Team B</span>
          </div>
          <div id="goalFlash" style="margin-top:0.25rem; font-size:0.75rem; color:#86efac;"></div>
        </div>
        <div style="width:20rem;">
          <div style="font-size:0.75rem; color:#9ca3af; margin-bottom:0.25rem;">Commentary</div>
          <div id="commentary" class="scroll" style="height:5rem; background:#06120d; border-radius:0.5rem; padding:0.5rem; font-size:0.875rem; color:#d1d5db;"></div>
        </div>
      </div>

      <div style="display:flex; gap:1rem; flex-direction:column; md:flex-direction:row;">
        <div class="pitch" id="pitch">
          <div class="ball" id="ball">Ball</div>
        </div>
        <div style="width:100%; max-width:20rem; display:flex; flex-direction:column; gap:0.75rem;">
          <div style="background:#07100f; padding:0.75rem; border-radius:0.5rem; border:1px solid #374151; height:14rem;" class="scroll">
            <div style="font-size:0.875rem; color:#9ca3af; margin-bottom:0.5rem;">Event Log</div>
            <div id="eventLog" style="font-size:0.875rem; color:#d1d5db;"></div>
          </div>
          <div style="background:#07100f; padding:0.75rem; border-radius:0.5rem; border:1px solid #374151;">
            <div style="display:flex; justify-content:space-between; margin-bottom:0.5rem;">
              <div style="font-size:0.875rem; color:#9ca3af;">Fouls / Cards</div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#d1d5db; margin-bottom:0.5rem;">
              <div>
                <div id="mTeamAName" style="font-weight:600; color:#86efac;">Team A</div>
                <div>F: <span id="fA">0</span> Y: <span id="yA">0</span> R: <span id="rA">0</span></div>
              </div>
              <div style="text-align:right;">
                <div id="mTeamBName" style="font-weight:600; color:#fca5a5;">Team B</div>
                <div>F: <span id="fB">0</span> Y: <span id="yB">0</span> R: <span id="rB">0</span></div>
              </div>
            </div>
            <button id="subBtn" class="btn" style="background:#166534; width:100%; margin-top:0.5rem;">Make Sub</button>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:1rem; align-items:center;">
        <div style="display:flex; gap:0.75rem;">
          <button id="pauseBtn" class="btn" style="background:#ca8a04; color:white; padding:0.5rem 0.75rem;">Pause</button>
          <button id="ffBtn" class="btn" style="background:#374151; color:white; padding:0.5rem 0.75rem;">Fast Forward</button>
        </div>
        <div id="poss" style="font-size:0.75rem; color:#9ca3af;">Possession — Team A 50% · Team B 50%</div>
      </div>
    </div>
  </div>

  <!-- Sub Modal -->
  <div id="subModal" class="overlay hidden">
    <div class="sub-modal">
      <h3 style="color:#86efac; margin-bottom:1rem; font-weight:600;">Substitution</h3>
      <select id="subOut"></select>
      <select id="subIn"></select>
      <div style="display:flex; gap:0.5rem; margin-top:1rem;">
        <button id="confirmSub" class="btn btn-green flex-1">Confirm</button>
        <button id="cancelSub" class="btn" style="background:#374151; color:white; flex-1;">Cancel</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>

<script>
/* ========================================
   CONFIG & DATA
   ======================================== */
const STARTERS = 11, SUBS = 4;
const ABILITIES = ['Shooting', 'Passing', 'Pace', 'Physical', 'Dribbling'];

const POOL = {
  "E. Martínez": "GK", "M. ter Stegen": "GK", "G. Donnarumma": "GK", "A. Becker": "GK", "Ederson": "GK",
  "Virgil van Dijk": "DEF", "Trent Alexander-Arnold": "DEF", "Rúben Dias": "DEF", "João Cancelo": "DEF",
  "A. Robertson": "DEF", "Sergio Ramos": "DEF", "Thiago Silva": "DEF", "Marquinhos": "DEF", "K. Trippier": "DEF",
  "K. De Bruyne": "MID", "Pedri": "MID", "Gavi": "MID", "Rodri": "MID", "T. Kroos": "MID", "L. Modrić": "MID",
  "J. Bellingham": "MID", "M. Ødegaard": "MID", "N. Kanté": "MID", "B. Guimarães": "MID", "Declan Rice": "MID",
  "C. Ronaldo": "CF", "L. Messi": "CAM", "K. Mbappé": "ATT", "E. Haaland": "ATT", "Neymar Jr": "ATT", "V. Jr.": "ATT",
  "M. Salah": "ATT", "K. Benzema": "ATT", "R. Lewandowski": "ATT", "H. Kane": "ATT"
};
const NAMES = Object.keys(POOL);

/* ========================================
   ELEMENTS
   ======================================== */
const $ = (id) => document.getElementById(id);
const els = {
  aName: $('teamAName'), bName: $('teamBName'),
  tickA: $('tickA'), tickB: $('tickB'),
  pA: $('players-A'), pB: $('players-B'),
  start: $('startBtn'), load: $('loading'), cd: $('countdown'), lt: $('loadText'),
  modal: $('matchModal'), mA: $('mTeamA'), mB: $('mTeamB'), sA: $('scoreA'), sB: $('scoreB'),
  time: $('time'), log: $('eventLog'), com: $('commentary'), poss: $('poss'),
  fA: $('fA'), fB: $('fB'), yA: $('yA'), yB: $('yB'), rA: $('rA'), rB: $('rB'),
  gf: $('goalFlash'), ball: $('ball'), pitch: $('pitch'),
  pause: $('pauseBtn'), ff: $('ffBtn'), close: $('closeBtn'), sub: $('subBtn'),
  subM: $('subModal'), out: $('subOut'), in: $('subIn'), conf: $('confirmSub'), canc: $('cancelSub')
};

/* ========================================
   STATE
   ======================================== */
let state = {
  A: { name: 'Team A', players: [], stats: { f:0, y:0, r:0 } },
  B: { name: 'Team B', players: [], stats: { f:0, y:0, r:0 } },
  sim: { run: false, min: 0, score: {A:0,B:0}, poss: 50, speed: 800, int: null, gg: false }
};

/* ========================================
   HELPERS
   ======================================== */
const random = (arr) => arr[Math.floor(Math.random() * arr.length)];
const wait = (ms) => new Promise(r => setTimeout(r, ms));
const posOf = (name) => {
  const first = name.split(' ')[0].replace(/\./g, '');
  return Object.keys(POOL).find(k => k.split(' ')[0].replace(/\./g, '') === first) ? POOL[Object.keys(POOL).find(k => k.split(' ')[0].replace(/\./g, '') === first)] : 'ATT';
};
const unique = (used) => {
  let n; do { n = random(NAMES); if (Math.random()<0.15) n += ' '+(10+Math.floor(Math.random()*90)); } while (used.has(n));
  return n;
};
const pick = (team) => random(state[team].players.filter(p => p.starter)).name;

/* ========================================
   GENERATE TEAM
   ======================================== */
function gen(teamId, name) {
  const used = new Set();
  const p = [];
  if (teamId === 'A') { p.push({name:"C. Ronaldo", pos:"CF", ab:random(ABILITIES,3), starter:true}); used.add("C. Ronaldo"); }
  if (teamId === 'B') { p.push({name:"L. Messi", pos:"CAM", ab:random(ABILITIES,3), starter:true}); used.add("L. Messi"); }

  const slots = ['GK',...'DEF'.repeat(4).split(''),...'MID'.repeat(4).split(''),'ATT','ATT'];
  let att = p.filter(x=>['CF','CAM','ATT'].includes(x.pos)).length;

  for (const pos of slots) {
    if (pos==='ATT' && att>=2) continue;
    let n; do { n = unique(used); } while (posOf(n) !== pos);
    used.add(n); p.push({name:n, pos, ab:random(ABILITIES,3), starter:true}); if (pos==='ATT') att++;
  }
  for (let i=0; i<SUBS; i++) {
    const pos = random(['DEF','MID','ATT']);
    let n; do { n = unique(used); } while (posOf(n) !== pos);
    used.add(n); p.push({name:n, pos, ab:random(ABILITIES,3), starter:false});
  }

  state[teamId].name = name || state[teamId].name;
  state[teamId].players = p;
  render(teamId);
  check();
}

function random(arr, n) {
  const s = [...arr]; for (let i=s.length-1;i>0;i--) { const j=Math.floor(Math.random()*(i+1)); [s[i],s[j]]=[s[j],s[i]]; }
  return s.slice(0, n);
}

/* ========================================
   RENDER
   ======================================== */
function render(id) {
  const c = id==='A' ? els.pA : els.pB;
  c.innerHTML = '';
  $(id==='A'?'teamATitle':'teamBTitle').textContent = state[id].name;
  state[id].players.forEach((pl, i) => {
    const sub = i >= STARTERS;
    const div = document.createElement('div');
    div.className = 'player-row';
    div.innerHTML = `<div><span style="color:${sub?'#9ca3af':'#86efac'}">${sub?'Sub':''} ${pl.name}</span><br><span style="font-size:0.75rem; color:#9ca3af">${pl.pos} · ${pl.ab.join(' · ')}</span></div>`;
    c.appendChild(div);
  });
}

let readyA = false, readyB = false;
els.tickA.onclick = () => { readyA = !readyA; els.tickA.classList.toggle('tick-on', readyA); if (readyA) gen('A', els.aName.value||'Real'); else { state.A.players=[]; render('A'); } check(); };
els.tickB.onclick = () => { readyB = !readyB; els.tickB.classList.toggle('tick-on', readyB); if (readyB) gen('B', els.bName.value||'Barca'); else { state.B.players=[]; render('B'); } check(); };
els.aName.oninput = () => readyA && gen('A', els.aName.value);
els.bName.oninput = () => readyB && gen('B', els.bName.value);

function check() { els.start.disabled = !(readyA && readyB && state.A.players.length && state.B.players.length); }

/* ========================================
   START MATCH
   ======================================== */
els.start.onclick = async () => {
  state.A.name = els.aName.value || state.A.name;
  state.B.name = els.bName.value || state.B.name;
  els.load.classList.remove('hidden');
  els.lt.textContent = 'Preparing…';
  for (let i=5; i>=0; i--) { els.cd.textContent = i; await wait(1000); }
  els.load.classList.add('hidden');
  runMatch();
};

/* ========================================
   MATCH LOOP
   ======================================== */
function runMatch() {
  state.sim = { run:true, min:0, score:{A:0,B:0}, poss:50, gg:false, int:null };
  els.sA.textContent = els.sB.textContent = '0';
  els.time.textContent = "0'";
  els.log.innerHTML = els.com.innerHTML = '';
  ['f','y','r'].forEach(k=> {state.A.stats[k]=state.B.stats[k]=0;});
  updateStats();
  els.mA.textContent = els.mTeamAName.textContent = state.A.name;
  els.mB.textContent = els.mTeamBName.textContent = state.B.name;
  drawPitch();
  els.modal.classList.remove('hidden');

  state.sim.int = setInterval(() => {
    if (!state.sim.run) return;
    state.sim.min++;
    els.time.textContent = Math.min(state.sim.min,95)+"'";
    tick();
    if (state.sim.min >= 95) end();
  }, state.sim.speed);
}

function tick() {
  state.sim.poss += Math.floor(Math.random()*5)-2;
  state.sim.poss = Math.max(30, Math.min(70, state.sim.poss));
  els.poss.textContent = `Possession — ${state.A.name} ${state.sim.poss}% · ${state.B.name} ${100-state.sim.poss}%`;

  const r = Math.random();
  const tA = 0.45 + (state.sim.poss-50)/200;
  const tB = 0.45 + (50-state.sim.poss)/200;
  if (r < tA) attack('A');
  else if (r > 1-tB) attack('B');
  else if (Math.random()<0.3) com("Midfield battle");

  if (Math.random()<0.065) foul();

  if (!state.sim.gg && state.sim.min>60 && state.sim.score.A + state.sim.score.B < 2) {
    state.sim.gg = true;
    setTimeout(() => force(state.sim.poss>=50?'A':'B'), 1600);
  }

  moveBall();
}

function attack(t) {
  const p = pick(t);
  com(`${p} attacks!`);
  setTimeout(() => {
    const x = Math.random();
    if (x<0.28) goal(t,p);
    else if (x<0.55) com("Saved!");
    else if (x<0.75) com("Blocked!");
    else com("Wide.");
  }, 400);
}

function goal(t, p) {
  state.sim.score[t]++;
  els[`s${t}`].textContent = state.sim.score[t];
  log(`GOAL! ${p}`);
  flash(`${p} SCORES!`);
  animBall(t==='A'?80:20, 50);
}

function foul() {
  const t = Math.random()<0.5?'A':'B';
  const p = pick(t);
  state[t].stats.f++; updateStats();
  log(`${p} foul`);
  if (Math.random()<0.12) setTimeout(() => pen(t==='A'?'B':'A'), 600);
  else if (Math.random()<0.28) {
    state[t].stats.y++; updateStats();
    log(`Yellow → ${p}`);
    card(t,p,'Y');
    if (Math.random()<0.05) { state[t].stats.r++; updateStats(); log(`Red! ${p}`); card(t,p,'R'); }
  }
}

function pen(t) {
  const p = pick(t);
  if (Math.random()<0.68) goal(t, p+" (pen)");
  else log(`PEN SAVED! ${p}`);
}

function force(t) { const p = pick(t); goal(t,p); }

/* ========================================
   PITCH
   ======================================== */
function drawPitch() {
  els.pitch.innerHTML = '<div class="ball" id="ball">Ball</div>';
  const posA = form('A'), posB = form('B');
  state.A.players.slice(0,STARTERS).forEach((p,i) => els.pitch.appendChild(pill(p.name,'A',posA[i])));
  state.B.players.slice(0,STARTERS).forEach((p,i) => els.pitch.appendChild(pill(p.name,'B',posB[i])));
  els.ball.style.left = '50%'; els.ball.style.top = '50%';
}

function form(t) {
  const x = t==='A'?28:72;
  return [{x,y:84},...Array(4).fill().map((_,i)=>({x:x-18+i*12,y:68})),...Array(4).fill().map((_,i)=>({x:x-18+i*12,y:48})),{x:x-6,y:28},{x:x+6,y:28}];
}

function pill(n,t,pos) {
  const e = document.createElement('div');
  e.className = `player-pill ${t==='B'?'b':''}`;
  e.style.left = pos.x+'%'; e.style.top = pos.y+'%';
  e.textContent = n.split(' ')[0];
  e.dataset.name = n;
  return e;
}

function moveBall() {
  const x = 50 + (state.sim.poss-50)*0.6;
  const y = 30 + Math.random()*40;
  animBall(x,y);
}

function animBall(x,y) {
  const b = els.ball, steps=12, step=0;
  const sx = parseFloat(b.style.left)||50, sy = parseFloat(b.style.top)||50;
  const dx = (x-sx)/steps, dy = (y-sy)/steps;
  const id = setInterval(() => {
    if (step++ >= steps) clearInterval(id);
    b.style.left = (sx + dx*step)+'%';
    b.style.top = (sy + dy*step)+'%';
  }, 30);
}

function card(t,n,type) {
  const p = els.pitch.querySelector(`[data-name="${n}"]`);
  if (!p) return;
  const i = document.createElement('div');
  i.textContent = type; i.style.position='absolute'; i.style.top='-1.25rem'; i.style.left='50%'; i.style.transform='translateX(-50%)';
  i.style.width='1.25rem'; i.style.height='1.25rem'; i.style.borderRadius='50%'; i.style.display='flex'; i.style.alignItems='center'; i.style.justifyContent='center';
  i.style.fontSize='0.625rem'; i.style.fontWeight='bold'; i.style.animation='pulse 1s infinite';
  i.style.backgroundColor = type==='Y'?'#facc15':'#ef4444'; i.style.color='#111';
  p.appendChild(i);
  setTimeout(() => i.remove(), 4000);
}

els.sub.onclick = () => {
  state.sim.run = false; els.pause.textContent = 'Resume';
  fillSub(); els.subM.classList.remove('hidden');
};

function fillSub() {
  const start = state.A.players.slice(0,STARTERS).concat(state.B.players.slice(0,STARTERS));
  const subs = state.A.players.slice(STARTERS).concat(state.B.players.slice(STARTERS));
  els.out.innerHTML = start.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
  els.in.innerHTML = subs.map(p=>`<option value="${p.name}">${p.name} (Sub)</option>`).join('');
}

els.conf.onclick = () => {
  const outN = els.out.value, inN = els.in.value;
  const outT = outN.includes(state.A.name)?'A':'B';
  const inT = state.A.players.slice(STARTERS).some(p=>p.name===inN)?'A':'B';
  const oi = state[outT].players.findIndex(p=>p.name===outN);
  const ii = state[inT].players.findIndex(p=>p.name===inN);
  if (oi>-1 && ii>-1) {
    [state[outT].players[oi], state[inT].players[ii]] = [state[inT].players[ii], state[outT].players[oi]];
    log(`SUB: ${inN} → ${outN}`);
    drawPitch();
  }
  els.subM.classList.add('hidden');
  state.sim.run = true; els.pause.textContent = 'Pause';
};

els.canc.onclick = () => { els.subM.classList.add('hidden'); state.sim.run = true; els.pause.textContent = 'Pause'; };

/* ========================================
   END & PENALTIES
   ======================================== */
async function end() {
  clearInterval(state.sim.int);
  log(`FT: ${state.A.name} ${state.sim.score.A}-${state.sim.score.B} ${state.B.name}`);
  if (state.sim.score.A + state.sim.score.B < 2) {
    const f = state.sim.poss>=50?'A':'B';
    for (let i=0; i<2-(state.sim.score.A+state.sim.score.B); i++) { force(f); await wait(800); }
  }
  if (state.sim.score.A === state.sim.score.B) { com("Penalties!"); await wait(1500); await pens(); }
  else flash(`${state.sim.score.A > state.sim.score.B ? state.A.name : state.B.name} WINS!`);
  state.sim.run = false;
}

async function pens() {
  let sa=0, sb=0;
  const a = state.A.players.slice(0,5).map(p=>p.name);
  const b = state.B.players.slice(0,5).map(p=>p.name);
  for (let i=0; i<5; i++) {
    if (Math.random()<0.75) { sa++; log(`PEN: ${a[i]} scores`); flash(`${a[i]} (pen)`); } else log(`PEN: ${a[i]} misses`);
    await wait(700);
    if (Math.random()<0.75) { sb++; log(`PEN: ${b[i]} scores`); flash(`${b[i]} (pen)`); } else log(`PEN: ${b[i]} misses`);
    await wait(700);
    if (sa > sb+(4-i) || sb > sa+(4-i)) break;
  }
  while (sa===sb) {
    const pa = pick('A'), pb = pick('B');
    if (Math.random()<0.72) sa++; else log(`Sudden: ${pa} misses`);
    await wait(700);
    if (Math.random()<0.72) sb++; else log(`Sudden: ${pb} misses`);
    await wait(700);
  }
  log(`PENS: ${state.A.name} ${sa}-${sb} ${state.B.name}`);
  flash(`${sa>sb?state.A.name:state.B.name} wins on pens!`);
}

/* ========================================
   UI
   ======================================== */
function log(m) { const d=document.createElement('div'); d.textContent=m; d.style.marginBottom='0.25rem'; els.log.prepend(d); com(m); }
function com(m) { const d=document.createElement('div'); d.innerHTML=`<span style="color:#9ca3af">[${new Date().toTimeString().slice(0,5)}]</span> ${m}`; d.style.fontSize='0.75rem'; d.style.marginBottom='0.25rem'; els.com.prepend(d); }
function flash(t) { els.gf.innerHTML = `<div class="goal-flash" style="background:#16653420; color:#86efac; padding:0.5rem 1rem; border-radius:0.5rem; display:inline-block;">${t}</div>`; setTimeout(()=>{els.gf.innerHTML=''},2000); }
function updateStats() { els.fA.textContent=state.A.stats.f; els.fB.textContent=state.B.stats.f; els.yA.textContent=state.A.stats.y; els.yB.textContent=state.B.stats.y; els.rA.textContent=state.A.stats.r; els.rB.textContent=state.B.stats.r; }

/* ========================================
   CONTROLS
   ======================================== */
els.pause.onclick = () => { state.sim.run = !state.sim.run; els.pause.textContent = state.sim.run ? 'Pause' : 'Resume'; };
els.ff.onclick = () => { state.sim.min += 6; els.time.textContent = Math.min(state.sim.min,95)+"'"; };
els.close.onclick = () => { clearInterval(state.sim.int); state.sim.run = false; els.modal.classList.add('hidden'); };

/* ========================================
   DRAG
   ======================================== */
let drag = null;
els.pitch.onpointerdown = e => {
  const p = e.target.closest('.player-pill');
  if (!p || !state.sim.run) return;
  drag = p; p.setPointerCapture(e.pointerId); p.style.cursor='grabbing';
};
els.pitch.onpointermove = e => {
  if (!drag) return;
  const r = els.pitch.getBoundingClientRect();
  let x = (e.clientX - r.left)/r.width*100;
  let y = (e.clientY - r.top)/r.height*100;
  x = Math.max(5, Math.min(95, x)); y = Math.max(5, Math.min(95, y));
  drag.style.left = x+'%'; drag.style.top = y+'%';
};
els.pitch.onpointerup = () => { if (drag) { drag.style.cursor='grab'; drag.releasePointerCapture(); drag=null; } };

/* ========================================
   BALL MOVEMENT
   ======================================== */
setInterval(() => { if (state.sim.run) moveBall(); }, 1200);

window.state = state;
</script>

</body>
</html>
```

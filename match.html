<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GOLDEN FIRE MATCH PRO — 13.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --green-team: #10b981;
      --red-team: #ef4444;
      --gold: #fbbf24;
      --fire: #f97316;
      --pitch-dark: #013a2a;
      --pitch-light: #02584b;
      --danger-glow: 0 0 35px rgba(251,191,36,0.9);
      --safe-glow: 0 0 25px rgba(34,197,94,0.7);
      --ball-shadow: 0 5px 15px rgba(0,0,0,0.6), 0 0 20px rgba(251,191,36,0.5);
      --pitch-glow: inset 0 0 60px rgba(251,191,36,0.2);
    }
    body { font-family: 'Inter', sans-serif; background: #000; }
    .pitch-container {
      background: radial-gradient(circle at center, #034c3c 0%, #013a2a 100%);
      border-radius: 28px; position: relative; overflow: hidden;
      box-shadow: 0 40px 80px rgba(0,0,0,0.85), var(--pitch-glow);
      border: 4px solid rgba(251,191,36,0.4);
      width: 100%; height: 720px; max-width: 1100px; margin: 0 auto;
      padding: 20px;
    }
    .pitch {
      position: relative; width: 100%; height: 100%; overflow: hidden;
      border-radius: 20px;
      background: linear-gradient(180deg, #02584b 0%, #013a2a 100%);
    }
    .pitch-line { 
      position: absolute; background: rgba(255,255,255,0.28); 
      box-shadow: 0 0 8px rgba(255,255,255,0.3);
    }
    .center-circle { 
      position: absolute; width: 140px; height: 140px; border: 3.5px solid rgba(251,191,36,0.45); 
      border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%,-50%); 
    }
    .center-spot { 
      position: absolute; width: 14px; height: 14px; background: #fbbf24; border-radius: 50%; 
      left: 50%; top: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 25px rgba(251,191,36,1);
    }
    .penalty-area { 
      position: absolute; border: 3px solid rgba(255,255,255,0.35); 
      background: rgba(255,255,255,0.04);
    }
    .goal-area { 
      position: absolute; border: 3px solid rgba(255,255,255,0.35); 
      background: rgba(255,255,255,0.06);
    }
    .goal-post {
      position: absolute; width: 10px; height: 56px; background: #fff; 
      box-shadow: 0 0 20px rgba(255,255,255,0.8); z-index: 10;
      border-radius: 4px;
    }
    .goal-net {
      position: absolute; width: 120px; height: 60px; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.12), rgba(255,255,255,0.12) 12px, transparent 12px, transparent 24px);
      border: 3px solid rgba(255,255,255,0.35); z-index: 5; opacity: 0.7;
      border-radius: 6px;
    }
    .player-pill {
      min-width: 74px; height: 50px; text-align: center; 
      box-shadow: 0 12px 32px rgba(0,0,0,0.75), 0 0 22px rgba(251,191,36,0.4);
      transition: all .26s cubic-bezier(.4,0,.2,1); z-index: 30; cursor: grab; font-weight: 700;
      display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 9999px;
      backdrop-filter: blur(10px); border: 3px solid;
      font-size: 0.82rem; letter-spacing: 0.7px; padding: 0 8px;
      background: rgba(0,0,0,0.3);
    }
    .player-pill:active { cursor: grabbing; transform: scale(1.2); }
    .player-pill.team-a { 
      background: linear-gradient(135deg, rgba(16,185,129,0.35), rgba(5,150,105,0.25)); 
      border-color: rgba(16,185,129,0.7); color: #d1fae5; 
    }
    .player-pill.team-b { 
      background: linear-gradient(135deg, rgba(239,68,68,0.35), rgba(220,38,38,0.25)); 
      border-color: rgba(239,68,68,0.7); color: #fecaca; 
    }
    .player-pill.danger {
      animation: dangerPulse 1.2s infinite;
      box-shadow: var(--danger-glow), 0 0 25px rgba(249,115,22,1) !important;
      border-color: #fbbf24 !important;
    }
    .player-pill.safe {
      animation: safePulse 1.6s infinite;
      box-shadow: var(--safe-glow), 0 0 18px rgba(16,185,129,0.8) !important;
      border-color: #10b981 !important;
    }
    @keyframes dangerPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.25); }
    }
    @keyframes safePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.18); }
    }
    .ball {
      width: 32px; height: 32px; 
      background: radial-gradient(circle at 40% 40%, #fff, #e5e7eb 60%, #bbb 100%);
      box-shadow: var(--ball-shadow); z-index: 25; 
      transition: all .32s cubic-bezier(0.4, 0, 0.2, 1); border: 2.5px solid #fbbf24;
      border-radius: 50%; position: absolute;
    }
    .ball.danger { animation: ballDanger 0.85s infinite; }
    @keyframes ballDanger { 0%,100% { box-shadow: var(--ball-shadow), 0 0 30px #f97316; } 50% { box-shadow: var(--ball-shadow), 0 0 45px #f97316; } }
    .pass-line {
      position: absolute; height: 3px; background: rgba(251,191,36,0.8); 
      transform-origin: left center; z-index: 15; opacity: 0;
      box-shadow: 0 0 15px rgba(251,191,36,0.7);
      border-radius: 2px;
    }
    .pass-line.show { animation: passAnim 0.65s ease-out forwards; }
    @keyframes passAnim {
      0% { opacity: 1; transform: scaleX(0); }
      70% { opacity: 1; transform: scaleX(1.15); }
      100% { opacity: 0; transform: scaleX(1); }
    }
    .goal-flash { 
      animation: goalPulse 0.85s ease-out forwards; position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(90deg, rgba(251,191,36,0.4), rgba(34,197,94,0.4)); 
      color: #fbbf24; padding: 16px 36px; border-radius: 16px; font-weight: 800; font-size: 1.3rem;
      box-shadow: 0 0 60px rgba(251,191,36,0.8), 0 0 30px rgba(34,197,94,0.7); 
      backdrop-filter: blur(12px); border: 2.5px solid rgba(251,191,36,0.6);
      text-shadow: 0 3px 12px rgba(0,0,0,0.7);
    }
    @keyframes goalPulse {
      0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
      40% { transform: translateX(-50%) scale(1.45); }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
    .loading-overlay { backdrop-filter: blur(16px); background: rgba(0,0,0,0.96); }
    .team-card { transition: all .3s; }
    .team-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(251,191,36,0.2); }
    .possession-bar { height: 12px; border-radius: 6px; overflow: hidden; background: #1f2937; border: 1.5px solid #374151; }
    .possession-fill { height: 100%; transition: width .9s ease; }
    .possession-fill.a { background: linear-gradient(90deg, #10b981, #34d399); }
    .possession-fill.b { background: linear-gradient(90deg, #ef4444, #fca5a5); }
    .btn-primary { 
      background: linear-gradient(135deg, #f59e0b, #f97316); color: white; font-weight: 700; 
      box-shadow: 0 10px 20px rgba(249,115,22,0.5);
      border-radius: 14px;
    }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 26px rgba(249,115,22,0.6); }
    .btn-secondary { background: #374151; border-radius: 12px; }
    .btn-secondary:hover { background: #4b5563; }
    .commentary-line { font-size: 14.5px; line-height: 1.8; }
    .commentary-line .time { color: #94a3b8; font-family: monospace; font-weight: 600; }
    .score-line {
      font-weight: 900; font-size: 4rem; letter-spacing: -4px;
      background: linear-gradient(90deg, #10b981, #fbbf24, #ef4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 5px 15px rgba(0,0,0,0.6);
      transition: all .4s ease;
    }
    .score-line.goal { animation: scorePulse 0.8s ease-out; }
    @keyframes scorePulse {
      0% { transform: scale(1); }
      45% { transform: scale(1.4); }
      100% { transform: scale(1); }
    }
    .commentary-line.live {
      color: #fbbf24; font-weight: 700; animation: liveBlink 1.4s infinite;
      text-shadow: 0 0 14px rgba(251,191,36,0.7);
    }
    @keyframes liveBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .arrow-indicator {
      position: absolute; font-size: 2.2rem; color: #fbbf24; z-index: 28; opacity: 0;
      transition: opacity .35s; text-shadow: 0 0 20px rgba(251,191,36,1);
      animation: arrowPulse 1s infinite;
    }
    .arrow-indicator.show { opacity: 1; }
    @keyframes arrowPulse {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 min-h-screen">

  <div class="container mx-auto p-5 md:p-8 max-w-7xl">
    <!-- Header -->
    <header class="mb-10 text-center">
      <h1 class="text-6xl md:md:text-7xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 via-amber-400 to-rose-500 drop-shadow-lg">
        <i class="fas fa-futbol mr-4 animate-pulse"></i> GOLDEN FIRE MATCH PRO
      </h1>
      <p class="text-slate-300 mt-4 text-lg md:text-xl font-medium">
        <i class="fas fa-bolt mr-2 text-amber-400"></i> Real-Time • Moving Ball • Dynamic Players • Full Pitch
      </p>
    </header>

    <main class="grid lg:grid-cols-12 gap-8">
      <!-- Team A Panel -->
      <section class="lg:col-span-3">
        <div class="bg-slate-900/90 backdrop-blur-3xl p-7 rounded-3xl border border-amber-500/35 shadow-2xl team-card">
          <div class="flex items-center justify-between mb-6">
            <input id="teamAName" class="flex-1 bg-transparent border border-slate-700 rounded-xl px-5 py-3 text-sm focus:border-amber-500 focus:outline-none transition" 
                   placeholder="Team A name" value="Real Team A"/>
            <button id="tickA" class="ml-4 px-6 py-3 rounded-xl bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold text-sm hover:from-amber-700 hover:to-amber-800 transition shadow-xl">
              <i class="fas fa-robot mr-1"></i> AI
            </button>
          </div>
          <h3 id="teamATitle" class="text-2xl font-bold text-emerald-400 mb-5 flex items-center">
            <i class="fas fa-shield-alt mr-2"></i> Real Team A
          </h3>
          <div id="players-A" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
        </div>
      </section>

      <!-- Center: Pitch + Controls -->
      <section class="lg:col-span-6">
        <div class="bg-slate-900/90 backdrop-blur-3xl p-7 rounded-3xl border border-amber-500/35 shadow-2xl">
          <!-- Controls -->
          <div class="flex flex-wrap gap-4 mb-7">
            <button id="startFlowBtn" class="flex-1 md:flex-initial px-8 py-4 rounded-2xl btn-primary text-white font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-xl">
              <i class="fas fa-play mr-2"></i> IGNITE MATCH
            </button>
            <button id="pauseBtn" class="px-7 py-4 rounded-xl btn-secondary text-white font-bold shadow-lg">
              <i class="fas fa-pause"></i> Pause
            </button>
            <button id="ffBtn" class="px-7 py-4 rounded-xl btn-secondary text-white font-bold shadow-lg">
              <i class="fas fa-forward"></i> +6'
            </button>
          </div>

          <!-- Score & Time -->
          <div class="bg-gradient-to-r from-slate-800/85 to-slate-900/85 backdrop-blur p-6 rounded-2xl mb-7 border border-amber-500/25 shadow-2xl">
            <div class="grid grid-cols-3 items-center text-center">
              <div>
                <div id="modalTeamA" class="text-xl font-bold text-emerald-400 flex items-center justify-center">
                  <i class="fas fa-flag mr-2"></i> Real Team A
                </div>
                <div id="modalTeamAName" class="text-xs text-slate-300 mt-1">Real Team A</div>
              </div>
              <div>
                <div class="flex items-center justify-center gap-5">
                  <div id="scoreA" class="score-line">0</div>
                  <div class="text-5xl font-bold text-amber-400">—</div>
                  <div id="scoreB" class="score-line">0</div>
                </div>
                <div id="matchTime" class="text-3xl font-mono text-amber-400 mt-3 font-bold">0'</div>
                <div class="possession-bar mt-4">
                  <div id="possessionFillA" class="possession-fill a" style="width:50%"></div>
                </div>
                <div id="possessionInfo" class="text-sm text-slate-300 mt-3 font-medium">Possession — 50% · 50%</div>
              </div>
              <div>
                <div id="modalTeamB" class="text-xl font-bold text-rose-400 flex items-center justify-center">
                  <i class="fas fa-flag mr-2"></i> Real Team B
                </div>
                <div id="modalTeamBName" class="text-xs text-slate-300 mt-1">Real Team B</div>
              </div>
            </div>
          </div>

          <!-- SPACIOUS PITCH -->
          <div class="pitch-container relative">
            <div class="pitch" id="pitch">
              <!-- Pitch Lines -->
              <div class="pitch-line" style="left:0;right:0;top:50%;height:3px;"></div>
              <div class="pitch-line" style="left:50%;top:0;bottom:0;width:3px;"></div>
              <div class="center-circle"></div>
              <div class="center-spot"></div>

              <!-- Penalty Areas -->
              <div class="penalty-area" style="left:4%;top:18%;width:28%;height:64%;"></div>
              <div class="penalty-area" style="right:4%;top:18%;width:28%;height:64%;"></div>
              <div class="goal-area" style="left:10%;top:32%;width:16%;height:36%;"></div>
              <div class="goal-area" style="right:10%;top:32%;width:16%;height:36%;"></div>

              <!-- Goalposts & Nets -->
              <div class="goal-post" style="left:0.8%;top:40%;"></div>
              <div class="goal-post" style="left:4.2%;top:40%;"></div>
              <div class="goal-net" style="left:-3%;top:38%;"></div>

              <div class="goal-post" style="right:0.8%;top:40%;"></div>
              <div class="goal-post" style="right:4.2%;top:40%;"></div>
              <div class="goal-net" style="right:-3%;top:38%;"></div>

              <!-- Ball -->
              <div id="ball" class="ball" style="left:50%;top:50%;transform:translate(-50%,-50%)"></div>

              <!-- Pass Line -->
              <div id="passLine" class="pass-line"></div>

              <!-- Goal Flash -->
              <div id="goalFlashHolder" class="absolute top-6 left-1/2 -translate-x-1/2"></div>

              <!-- Arrow Indicator -->
              <div id="arrowIndicator" class="arrow-indicator">Down Arrow</div>
            </div>
          </div>

          <!-- Stats -->
          <div class="grid grid-cols-3 gap-5 mt-7 text-center">
            <div class="bg-gradient-to-b from-slate-800/75 to-slate-900/75 p-5 rounded-xl border border-amber-500/25 backdrop-blur">
              <div class="text-sm text-slate-300 font-medium">Fouls</div>
              <div class="text-2xl font-bold text-amber-400"><span id="mA-fouls">0</span> · <span id="mB-fouls">0</span></div>
            </div>
            <div class="bg-gradient-to-b from-slate-800/75 to-slate-900/75 p-5 rounded-xl border border-amber-500/25 backdrop-blur">
              <div class="text-sm text-slate-300 font-medium">Yellow</div>
              <div class="text-2xl font-bold text-amber-400"><span id="mA-y">0</span> · <span id="mB-y">0</span></div>
            </div>
            <div class="bg-gradient-to-b from-slate-800/75 to-slate-900/75 p-5 rounded-xl border border-amber-500/25 backdrop-blur">
              <div class="text-sm text-slate-300 font-medium">Red</div>
              <div class="text-2xl font-bold text-amber-400"><span id="mA-r">0</span> · <span id="mB-r">0</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Team B + Events -->
      <section class="lg:col-span-3">
        <div class="bg-slate-900/90 backdrop-blur-3xl p-7 rounded-3xl border border-amber-500/35 shadow-2xl team-card">
          <div class="flex items-center justify-between mb-6">
            <input id="teamBName" class="flex-1 bg-transparent border border-slate-700 rounded-xl px-5 py-3 text-sm focus:border-amber-500 focus:outline-none transition" 
                   placeholder="Team B name" value="Real Team B"/>
            <button id="tickB" class="ml-4 px-6 py-3 rounded-xl bg-gradient-to-r from-amber-600 to-amber-700 text-white font-bold text-sm hover:from-amber-700 hover:to-amber-800 transition shadow-xl">
              <i class="fas fa-robot mr-1"></i> AI
            </button>
          </div>
          <h3 id="teamBTitle" class="text-2xl font-bold text-rose-400 mb-5 flex items-center">
            <i class="fas fa-shield-alt mr-2"></i> Real Team B
          </h3>
          <div id="players-B" class="space-y-3 max-h-64 overflow-y-auto pr-2 mb-7"></div>

          <div class="text-sm font-bold text-amber-400 mb-4 flex items-center">
            <i class="fas fa-list-ul mr-2"></i> LIVE EVENT LOG
          </div>
          <div id="eventLog" class="bg-slate-800/65 p-5 rounded-xl h-64 overflow-y-auto text-sm font-mono border border-amber-500/25 backdrop-blur"></div>
        </div>
      </section>
    </main>

    <!-- Commentary -->
    <section class="mt-10 bg-gradient-to-r from-slate-900/90 to-slate-950/90 backdrop-blur-3xl p-7 rounded-3xl border border-amber-500/35 shadow-2xl">
      <div class="flex items-center justify-between mb-6">
        <h4 class="text-2xl font-bold flex items-center text-amber-400">
          <i class="fas fa-microphone mr-3 animate-pulse"></i> LIVE GOLDEN COMMENTARY
        </h4>
        <div class="text-sm text-slate-300">Real-time play-by-play</div>
      </div>
      <div id="modalCommentary" class="h-60 overflow-y-auto pr-4 space-y-2 commentary-line text-sm"></div>
    </section>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center loading-overlay">
      <div class="bg-slate-900/98 p-12 rounded-3xl text-center border-3 border-amber-500/60 shadow-3xl">
        <div class="w-24 h-24 border-6 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
        <div id="loadingText" class="text-3xl font-bold text-amber-400">IGNITING THE PITCH…</div>
        <div id="countdown" class="text-6xl font-bold text-white mt-5">5</div>
      </div>
    </div>
  </div>

<script>
// ==============================
// FULL CONFIG & DATA
// ==============================
const starterCount = 11, subsCount = 4;
const abilitiesList = ['Shooting','Passing','Pace','Physical','Dribbling'];
const proPool = ["C. Ronaldo","L. Messi","K. Mbappé","E. Haaland","K. De Bruyne","Neymar Jr","V. Jr.","M. Salah","K. Benzema","R. Lewandowski","H. Kane","B. Silva","J. Kimmich","T. Müller","P. Foden","J. Grealish","R. Sterling","F. Valverde","B. Fernandes","Casemiro","Virgil van Dijk","T. Alexander-Arnold","Rúben Dias","João Cancelo","A. Robertson","Sergio Ramos","Thiago Silva","Marquinhos","E. Martínez","M. ter Stegen","G. Donnarumma","A. Becker","Ederson","K. Trippier","Pedri","Gavi","Rodri","T. Kroos","L. Modrić","J. Bellingham","M. Ødegaard","N. Kanté","B. Guimarães","Declan Rice","Enzo Fernández","Marco Reus","Ilkay Gündoğan","Paulo Dybala","Phil Foden","Jack Grealish","João Félix","Gabriel Jesus","Rashford","Sancho","Dembele","Lautaro Martínez","O. Giroud","Antony","Luis Díaz","Darwin Núñez","Federico Chiesa","R. Leão","Ansu Fati","T. Werner","S. Mané","Luka Jović","Angel Di María","Paul Pogba","Memphis Depay","Christian Eriksen","Z. Ibrahimović","Coutinho","Mesut Özil","Eden Hazard","Bale","Busquets","Chiellini","Bonucci"];

// ==============================
// ELEMENTS
// ==============================
const pitchEl = document.getElementById('pitch');
const ballEl = document.getElementById('ball');
const passLine = document.getElementById('passLine');
const goalFlashHolder = document.getElementById('goalFlashHolder');
const arrowIndicator = document.getElementById('arrowIndicator');
const teamANameInput = document.getElementById('teamAName');
const teamBNameInput = document.getElementById('teamBName');
const tickA = document.getElementById('tickA');
const tickB = document.getElementById('tickB');
const playersAContainer = document.getElementById('players-A');
const playersBContainer = document.getElementById('players-B');
const startFlowBtn = document.getElementById('startFlowBtn');
const pauseBtn = document.getElementById('pauseBtn');
const ffBtn = document.getElementById('ffBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const countdownEl = document.getElementById('countdown');
const loadingText = document.getElementById('loadingText');
const modalTeamA = document.getElementById('modalTeamA');
const modalTeamB = document.getElementById('modalTeamB');
const modalTeamAName = document.getElementById('modalTeamAName');
const modalTeamBName = document.getElementById('modalTeamBName');
const scoreAEl = document.getElementById('scoreA');
const scoreBEl = document.getElementById('scoreB');
const matchTimeEl = document.getElementById('matchTime');
const eventLog = document.getElementById('eventLog');
const modalCommentary = document.getElementById('modalCommentary');
const possessionInfo = document.getElementById('possessionInfo');
const possessionFillA = document.getElementById('possessionFillA');
const mA_fouls = document.getElementById('mA-fouls');
const mB_fouls = document.getElementById('mB-fouls');
const mA_y = document.getElementById('mA-y');
const mB_y = document.getElementById('mB-y');
const mA_r = document.getElementById('mA-r');
const mB_r = document.getElementById('mB-r');

// ==============================
// STATE
// ==============================
let state = {
  A: { name: 'Team A', players: [], counters: { fouls:0,y:0,r:0 } },
  B: { name: 'Team B', players: [], counters: { fouls:0,y:0,r:0 } },
  sim: { running:false, minute:0, total:90, extra:5, scoreA:0, scoreB:0, possessionA:50, interval: null, minGoalGuaranteeApplied: false }
};
let currentBallHolder = null;
let currentDangerPlayer = null;
let isSetPiece = false;

// ==============================
// HELPERS
// ==============================
function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }
function uniqueName(excludeSet){
  let name;
  do { name = randPick(proPool) + (Math.random()<0.15?(' '+Math.floor(Math.random()*90+10)):''); } 
  while (excludeSet && excludeSet.has(name));
  return name;
}
function makePlayer(name, pos, isSub=false){
  const abil = shuffle([...abilitiesList]).slice(0,3);
  return { name, position: pos, abilities: abil, isSub:isSub, confirmed:true, sentOff:false };
}

// ==============================
// PLAYER & BALL MOVEMENT
// ==============================
function movePlayerTo(el, x, y, duration = 700) {
  el.style.transition = `all ${duration}ms cubic-bezier(0.4, 0, 0.2, 1)`;
  el.style.left = x + '%';
  el.style.top = y + '%';
}
function moveBallTo(x, y, duration = 600) {
  ballEl.style.transition = `all ${duration}ms cubic-bezier(0.4, 0, 0.2, 1)`;
  ballEl.style.left = x + '%';
  ballEl.style.top = y + '%';
}
function drawPassLine(fromX, fromY, toX, toY) {
  const dx = toX - fromX;
  const dy = toY - fromY;
  const length = Math.sqrt(dx*dx + dy*dy);
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;
  passLine.style.width = length + '%';
  passLine.style.left = fromX + '%';
  passLine.style.top = fromY + '%';
  passLine.style.transform = `rotate(${angle}deg)`;
  passLine.classList.remove('show');
  void passLine.offsetWidth;
  passLine.classList.add('show');
}
async function passBall(fromPlayerEl, toPlayerEl) {
  const fromRect = fromPlayerEl.getBoundingClientRect();
  const toRect = toPlayerEl.getBoundingClientRect();
  const pitchRect = pitchEl.getBoundingClientRect();
  const fromX = ((fromRect.left + fromRect.width/2) - pitchRect.left) / pitchRect.width * 100;
  const fromY = ((fromRect.top + fromRect.height/2) - pitchRect.top) / pitchRect.height * 100;
  const toX = ((toRect.left + toRect.width/2) - pitchRect.left) / pitchRect.width * 100;
  const toY = ((toRect.top + toRect.height/2) - pitchRect.top) / pitchRect.height * 100;
  drawPassLine(fromX, fromY, toX, toY);
  moveBallTo(toX, toY, 650);
  currentBallHolder = toPlayerEl;
  await wait(700);
}

// ==============================
// PITCH & FORMATIONS
// ==============================
function drawPitchPlayers(){
  pitchEl.innerHTML = '';
  const layoutA = formationPositions('A');
  const layoutB = formationPositions('B');
  state.A.players.slice(0, starterCount).forEach((p,i)=>{
    if (p.sentOff) return;
    const el = createPlayerPill(p.name, 'A', i, layoutA[i]);
    pitchEl.appendChild(el);
  });
  state.B.players.slice(0, starterCount).forEach((p,i)=>{
    if (p.sentOff) return;
    const el = createPlayerPill(p.name, 'B', i, layoutB[i]);
    pitchEl.appendChild(el);
  });
  setBallPosition(50, 50);
  currentBallHolder = null;
}
function formationPositions(team){
  const baseX = team === 'A' ? 12 : 88;
  const pos = [];
  pos.push({ x: baseX, y: 50 });
  for (let i = 0; i < 4; i++) pos.push({ x: baseX + (team==='A'?1:-1)*(18 + i*14), y: 72 });
  for (let i = 0; i < 4; i++) pos.push({ x: baseX + (team==='A'?1:-1)*(12 + i*16), y: 45 });
  pos.push({ x: baseX + (team==='A'?1:-1)*30, y: 22 });
  pos.push({ x: baseX + (team==='A'?1:-1)*40, y: 22 });
  return pos;
}
function createPlayerPill(name, team, idx, pos){
  const el = document.createElement('div');
  el.className = `player-pill team-${team} absolute flex flex-col items-center justify-center text-xs font-semibold px-3 py-1 rounded-full gap-0.5`;
  el.dataset.team = team; el.dataset.idx = idx;
  el.style.left = pos.x + '%';
  el.style.top = pos.y + '%';
  el.style.transform = 'translate(-50%,-50%)';
  const short = name.split(' ')[0];
  el.innerHTML = `<div class="text-[9px] opacity-75">${team==='A'?'A':'B'}${idx+1}</div><div class="text-xs">${short}</div>`;
  return el;
}
function setBallPosition(x, y){
  ballEl.style.left = x + '%';
  ballEl.style.top = y + '%';
  ballEl.style.transform = 'translate(-50%,-50%)';
}

// ==============================
// AI TEAM GENERATION
// ==============================
function aiGenerateTeam(teamId, displayName){
  const used = new Set();
  const starterPositions = ['GK','DEF','DEF','DEF','DEF','MID','MID','MID','MID','ATT','ATT'];
  const starters = new Array(starterPositions.length).fill(null);
  if (teamId === 'A') { starters[10] = makePlayer("C. Ronaldo", "CF", false); used.add("C. Ronaldo"); }
  if (teamId === 'B') { let idx = starterPositions.lastIndexOf('MID'); if (idx === -1) idx = starterPositions.lastIndexOf('ATT'); starters[idx] = makePlayer("L. Messi", "CAM", false); used.add("L. Messi"); }
  for (let i=0;i<starterPositions.length;i++){
    if (starters[i]) continue;
    const pos = starterPositions[i];
    let name = uniqueName(used); used.add(name);
    let posStr = pos === 'ATT' ? 'ST' : (pos === 'MID' ? 'CM' : pos);
    starters[i] = makePlayer(name, posStr, false);
  }
  const subs = [];
  for (let s=0;s<subsCount;s++){
    const name = uniqueName(used); used.add(name);
    const pos = randPick(['DEF','MID','ATT']);
    let posStr = pos === 'ATT' ? 'ST' : (pos === 'MID' ? 'CM' : 'DEF');
    subs.push(makePlayer(name, posStr, true));
  }
  shuffle(subs);
  const finalPlayers = starters.concat(subs);
  state[teamId].name = displayName || state[teamId].name;
  state[teamId].players = finalPlayers;
  renderTeamList(teamId);
  checkStartReady();
}
function renderTeamList(teamId){
  const cont = teamId==='A' ? playersAContainer : playersBContainer;
  cont.innerHTML = '';
  const team = state[teamId];
  if (teamId === 'A') document.getElementById('teamATitle').textContent = team.name;
  else document.getElementById('teamBTitle').textContent = team.name;
  team.players.forEach((p, idx) => {
    const isSub = idx >= starterCount;
    const slot = isSub ? `Sub ${idx - starterCount + 1}` : `Player ${idx+1}`;
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between bg-[#071413] p-3 rounded-xl border border-gray-800';
    row.innerHTML = `
      <div>
        <div class="text-sm text-gray-300 font-semibold">${slot} — <span class="text-green-300">${p.name}</span></div>
        <div class="text-xs text-gray-400 mt-1">${p.position} · ${p.abilities.join(' · ')}</div>
      </div>
      <div class="text-xs text-gray-400">${p.isSub ? 'Sub' : 'Starter'}</div>
    `;
    cont.appendChild(row);
  });
}

// ==============================
// UI & CONTROLS
// ==============================
let tickAOn=false, tickBOn=false;
tickA.addEventListener('click', ()=>{ const nm = teamANameInput.value.trim() || 'Real Team A'; tickAOn = !tickAOn; tickA.classList.toggle('ring-2', tickAOn); tickA.classList.toggle('ring-amber-500', tickAOn); if (tickAOn) { aiGenerateTeam('A', nm); teamANameInput.classList.add('border-amber-500'); } else { state.A.players=[]; renderTeamList('A'); teamANameInput.classList.remove('border-amber-500'); } });
tickB.addEventListener('click', ()=>{ const nm = teamBNameInput.value.trim() || 'Real Team B'; tickBOn = !tickBOn; tickB.classList.toggle('ring-2', tickBOn); tickB.classList.toggle('ring-amber-500', tickBOn); if (tickBOn) { aiGenerateTeam('B', nm); teamBNameInput.classList.add('border-amber-500'); } else { state.B.players=[]; renderTeamList('B'); teamBNameInput.classList.remove('border-amber-500'); } });
teamANameInput.addEventListener('input', ()=>{ if (tickAOn && teamANameInput.value.trim().length>0) aiGenerateTeam('A', teamANameInput.value.trim()); });
teamBNameInput.addEventListener('input', ()=>{ if (tickBOn && teamBNameInput.value.trim().length>0) aiGenerateTeam('B', teamBNameInput.value.trim()); });
function checkStartReady(){ const readyA = state.A.players.length >= starterCount + subsCount; const readyB = state.B.players.length >= starterCount + subsCount; const nameA = teamANameInput.value.trim().length>0 || state.A.name; const nameB = teamBNameInput.value.trim().length>0 || state.B.name; if (readyA && readyB && tickAOn && tickBOn && nameA && nameB){ startFlowBtn.disabled = false; } else startFlowBtn.disabled = true; }
setInterval(checkStartReady, 400);

// ==============================
// LOADING & START
// ==============================
startFlowBtn.addEventListener('click', async ()=>{
  state.A.name = teamANameInput.value.trim() || state.A.name;
  state.B.name = teamBNameInput.value.trim() || state.B.name;
  loadingOverlay.classList.remove('hidden');
  loadingText.textContent = 'AI is locking lineups & preparing tactics…';
  await wait(600);
  for (let i=5;i>=0;i--){ countdownEl.textContent = i; await wait(1000); }
  loadingText.textContent = 'Matchmaking — generating tactical writeup...';
  countdownEl.textContent = '';
  await wait(1200);
  loadingOverlay.classList.add('hidden');
  openMatchModalAndStart();
});
function openMatchModalAndStart(){
  modalTeamA.textContent = state.A.name; modalTeamB.textContent = state.B.name; modalTeamAName.textContent = state.A.name; modalTeamBName.textContent = state.B.name;
  state.sim.minute = 0; state.sim.scoreA = 0; state.sim.scoreB = 0; state.sim.possessionA = 50;
  scoreAEl.textContent = '0'; scoreBEl.textContent = '0'; matchTimeEl.textContent = "0'";
  eventLog.innerHTML=''; modalCommentary.innerHTML='';
  mA_fouls.textContent = 0; mB_fouls.textContent = 0; mA_y.textContent = 0; mB_y.textContent = 0; mA_r.textContent = 0; mB_r.textContent = 0;
  state.sim.minGoalGuaranteeApplied = false;
  drawPitchPlayers();
  state.sim.running = true;
  const tick = 900;
  if (state.sim.interval) clearInterval(state.sim.interval);
  state.sim.interval = setInterval(()=>{ if (!state.sim.running) return; state.sim.minute++; updateTimeUI(state.sim.minute); simulationTick(state.sim.minute); if (state.sim.minute >= (state.sim.total + state.sim.extra)){ clearInterval(state.sim.interval); finalizeMatch(); } }, tick);
}
function updateTimeUI(min){ const m = Math.min(min, state.sim.total + state.sim.extra); matchTimeEl.textContent = `${m}'`; }

// ==============================
// COMMENTARY & EVENTS
// ==============================
function pushCommentary(msg){ const el = document.createElement('div'); el.className = 'mb-2 text-sm commentary-line live'; const now = new Date(); const mm = String(now.getMinutes()).padStart(2,'0'); const ss = String(now.getSeconds()).padStart(2,'0'); el.innerHTML = `<span class="time">[${mm}:${ss}]</span> <span>${msg}</span>`; modalCommentary.prepend(el); setTimeout(() => { if (el.parentNode) el.classList.remove('live'); }, 4000); }
function pushEvent(msg){ const el = document.createElement('div'); el.className = 'mb-1 text-sm text-gray-300 event-item new'; el.innerText = msg; eventLog.prepend(el); setTimeout(() => el.classList.remove('new'), 100); pushCommentary(msg); }

// ==============================
// SIMULATION TICK
// ==============================
async function simulationTick(minute){
  const delta = Math.floor((Math.random()*7))-3;
  state.sim.possessionA = Math.max(30, Math.min(70, state.sim.possessionA + delta));
  const pA = state.sim.possessionA, pB = 100-pA;
  possessionInfo.textContent = `Possession — ${pA}% · ${pB}%`;
  possessionFillA.style.width = `${pA}%`;

  // Dynamic player movement
  const players = pitchEl.querySelectorAll('.player-pill');
  players.forEach(p => {
    const team = p.dataset.team;
    const baseX = team === 'A' ? 12 + (pA-50)*0.35 : 88 - (pA-50)*0.35;
    const offset = parseInt(p.dataset.idx);
    const yJitter = 20 + Math.random()*60;
    const newX = baseX + (team==='A'?1:-1)*(offset % 4 * 10);
    movePlayerTo(p, newX, yJitter, 900);
  });

  // Ball flow
  const attackingTeam = pA > 55 ? 'A' : (pB > 55 ? 'B' : (Math.random()<0.5?'A':'B'));
  const holderPool = [...pitchEl.querySelectorAll(`.player-pill.team-${attackingTeam}`)];
  if (!holderPool.length) return;
  let newHolder = randPick(holderPool);
  if (currentBallHolder && currentBallHolder !== newHolder && Math.random() < 0.65) {
    await passBall(currentBallHolder, newHolder);
  } else {
    const rect = newHolder.getBoundingClientRect();
    const pitchRect = pitchEl.getBoundingClientRect();
    const ballX = ((rect.left + rect.width/2) - pitchRect.left) / pitchRect.width * 100;
    const ballY = ((rect.top + rect.height/2) - pitchRect.top) / pitchRect.height * 100;
    moveBallTo(ballX, ballY, 700);
    currentBallHolder = newHolder;
  }

  if (Math.random() < 0.19) await resolveAttack(attackingTeam, minute);
  if (!state.sim.minGoalGuaranteeApplied && minute > 60 && state.sim.scoreA + state.sim.scoreB < 2){
    state.sim.minGoalGuaranteeApplied = true;
    setTimeout(()=> forceGoal(state.sim.possessionA >= 50 ? 'A' : 'B', minute + 1), 1800);
  }
}

// ==============================
// ATTACK & GOAL
// ==============================
async function resolveAttack(team, minute){
  const attacker = pickPlayerName(team);
  const attackerEl = [...pitchEl.querySelectorAll('.player-pill')].find(p => p.textContent.includes(attacker.split(' ')[0]));
  const defenderTeam = team === 'A' ? 'B' : 'A';
  const defender = pickPlayerName(defenderTeam);
  pushCommentary(`${minute}' — ${attacker} surges forward with intent!`);
  if (attackerEl) markDanger(attackerEl);
  await wait(600);
  const roll = Math.random();
  if (roll < 0.18 && Math.random() > 0.24){
    if (team==='A'){ state.sim.scoreA++; scoreAEl.textContent = state.sim.scoreA; } else { state.sim.scoreB++; scoreBEl.textContent = state.sim.scoreB; }
    pushEvent(`GOAL! ${attacker} — ${state[team].name} (${minute}')`);
    flashGoal(`${attacker} — ${state[team].name}`);
    animateScore(team);
  } else if (roll < 0.54){
    pushCommentary(`${minute}' — Keeper denies ${attacker}! Outstanding stop.`);
    if (attackerEl) markSafe(attackerEl);
  } else {
    pushCommentary(`${minute}' — ${attacker} blazes it wide. So close!`);
  }
  setTimeout(clearIndicators, 2000);
}
function markDanger(playerEl) { if (currentDangerPlayer) currentDangerPlayer.classList.remove('danger'); playerEl.classList.add('danger'); currentDangerPlayer = playerEl; ballEl.classList.add('danger'); arrowIndicator.classList.add('show'); arrowIndicator.style.left = playerEl.style.left; arrowIndicator.style.top = parseFloat(playerEl.style.top) - 18 + '%'; }
function markSafe(playerEl) { if (currentDangerPlayer) currentDangerPlayer.classList.remove('safe'); playerEl.classList.add('safe'); }
function clearIndicators() { if (currentDangerPlayer) currentDangerPlayer.classList.remove('danger'); currentDangerPlayer = null; ballEl.classList.remove('danger'); arrowIndicator.classList.remove('show'); }
function flashGoal(text){ const el = document.createElement('div'); el.className = 'goal-flash'; el.textContent = text; goalFlashHolder.innerHTML = ''; goalFlashHolder.appendChild(el); setTimeout(()=> goalFlashHolder.innerHTML='', 3000); }
function animateScore(team) { const el = team === 'A' ? scoreAEl : scoreBEl; el.classList.add('goal'); setTimeout(() => el.classList.remove('goal'), 800); }
function forceGoal(team, minute){ const scorer = pickPlayerName(team); if (team==='A'){ state.sim.scoreA++; scoreAEl.textContent = state.sim.scoreA; } else { state.sim.scoreB++; scoreBEl.textContent = state.sim.scoreB; } pushEvent(`BREAKTHROUGH! ${scorer} — ${state[team].name} (${minute}')`); flashGoal(`${scorer} — ${state[team].name} (${minute}')`); animateScore(team); }

// ==============================
// UTILS
// ==============================
function pickPlayerName(teamId){ const pool = state[teamId].players.filter(p=>p && p.name && !p.sentOff); if (!pool.length) return 'Unknown'; const starters = pool.slice(0, starterCount); if (starters.length) return starters[Math.floor(Math.random()*starters.length)].name; return pool[Math.floor(Math.random()*pool.length)].name; }

// ==============================
// FINALIZE MATCH
// ==============================
async function finalizeMatch(){
  pushEvent(`Full Time — ${state.A.name} ${state.sim.scoreA} — ${state.sim.scoreB} ${state.B.name}`);
  if (state.sim.scoreA === state.sim.scoreB){ pushCommentary('Match ends level — Preparing penalty shootout!'); await wait(1200); await runPenalties(); } 
  else { const winner = state.sim.scoreA > state.sim.scoreB ? state.A.name : state.B.name; pushEvent(`${winner} wins! Final score: ${state.A.name} ${state.sim.scoreA} — ${state.sim.scoreB} ${state.B.name}`); flashGoal(`${winner} wins!`); }
  state.sim.running = false;
}
async function runPenalties(){
  pushCommentary('Penalty shootout starting — best of 5 each.');
  const shootersA = state.A.players.slice(0,5).map(p=>p.name);
  const shootersB = state.B.players.slice(0,5).map(p=>p.name);
  let scoreA = 0, scoreB = 0;
  for (let i=0;i<5;i++){
    const shootA = shootersA[i]; const scoredA = Math.random() < 0.75; if (scoredA){ scoreA++; pushEvent(`Penalty scored — ${shootA} ( ${state.A.name} )`); flashGoal(`${shootA} (pen)`); } else pushEvent(`Penalty missed — ${shootA} ( ${state.A.name} )`); await wait(700);
    const shootB = shootersB[i]; const scoredB = Math.random() < 0.75; if (scoredB){ scoreB++; pushEvent(`Penalty scored — ${shootB} ( ${state.B.name} )`); flashGoal(`${shootB} (pen)`); } else pushEvent(`Penalty missed — ${shootB} ( ${state.B.name} )`); await wait(700);
    if (scoreA > scoreB + (4 - i) || scoreB > scoreA + (4 - i)) break;
  }
  while (scoreA === scoreB){ const shooterA = pickPlayerName('A'); const shooterB = pickPlayerName('B'); const sA = Math.random() < 0.72; const sB = Math.random() < 0.72; if (sA){ scoreA++; pushEvent(`Sudden death — ${shooterA} scores for ${state.A.name}`); flashGoal(`${shooterA} (pen)`); } else pushEvent(`Sudden death — ${shooterA} misses`); await wait(700); if (sB){ scoreB++; pushEvent(`Sudden death — ${shooterB} scores for ${state.B.name}`); flashGoal(`${shooterB} (pen)`); } else pushEvent(`Sudden death — ${shooterB} misses`); await wait(700); if (scoreA !== scoreB) break; }
  pushEvent(`Penalties — ${state.A.name} ${scoreA} — ${scoreB} ${state.B.name}`);
  const winner = scoreA>scoreB ? state.A.name : state.B.name;
  pushEvent(`${winner} wins on penalties!`);
  flashGoal(`${winner} wins on pens`);
}

// ==============================
// CONTROLS & INIT
// ==============================
pauseBtn.addEventListener('click', ()=>{ state.sim.running = !state.sim.running; pauseBtn.innerHTML = state.sim.running ? '<i class="fas fa-pause"></i> Pause' : '<i class="fas fa-play"></i> Resume'; });
ffBtn.addEventListener('click', ()=>{ state.sim.minute += 6; updateTimeUI(state.sim.minute); });
window.addEventListener('beforeunload', ()=>{ if (state.sim.interval) clearInterval(state.sim.interval); });
aiGenerateTeam('A','Real Team A');
aiGenerateTeam('B','Real Team B');
</script>
</body>
</html>

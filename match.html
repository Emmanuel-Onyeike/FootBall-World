<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Match Simulator Pro — Live 10.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root {
      --green-team: #10b981;
      --red-team: #ef4444;
      --pitch-dark: #013a2a;
      --pitch-light: #02584b;
      --card-glow: 0 0 20px rgba(34,197,94,0.4);
    }
    body { font-family: 'Inter', sans-serif; }
    .pitch { 
      background: linear-gradient(180deg, var(--pitch-light) 0%, var(--pitch-dark) 100%);
      border-radius: 12px; position: relative; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }
    .player-pill {
      min-width: 56px; height: 36px; text-align: center; box-shadow: 0 6px 20px rgba(0,0,0,0.7);
      transition: all .18s cubic-bezier(.4,0,.2,1); z-index: 30; cursor: grab; font-weight: 600;
      display: flex; align-items: center; justify-content: center; border-radius: 9999px;
      backdrop-filter: blur(4px);
    }
    .player-pill:active { cursor: grabbing; transform: scale(1.1); }
    .player-pill.team-a { background: rgba(16,185,129,0.18); border: 1.5px solid rgba(16,185,129,0.3); color: #d1fae5; }
    .player-pill.team-b { background: rgba(239,68,68,0.18); border: 1.5px solid rgba(239,68,68,0.3); color: #fecaca; }
    .goal-flash { 
      animation: goalPulse 0.6s ease-out forwards; position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      background: rgba(34,197,94,0.2); color: #34d399; padding: 8px 20px; border-radius: 8px; font-weight: 700;
      box-shadow: 0 0 30px rgba(34,197,94,0.5); backdrop-filter: blur(6px);
    }
    @keyframes goalPulse {
      0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
      50% { transform: translateX(-50%) scale(1.15); }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }
    .ball { 
      width: 16px; height: 16px; background: radial-gradient(circle at 30% 30%, #fff, #e5e7eb);
      box-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 25; transition: all .3s ease;
    }
    .loading-overlay { backdrop-filter: blur(8px); background: rgba(0,0,0,0.85); }
    .team-card { transition: all .2s; }
    .team-card:hover { transform: translateY(-2px); }
    .event-item { transition: opacity .3s; }
    .event-item.new { animation: fadeIn .4s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: none; } }
    .stat-badge { font-size: 11px; padding: 2px 6px; border-radius: 6px; font-weight: 700; }
    .possession-bar { height: 6px; border-radius: 3px; overflow: hidden; background: #1f2937; }
    .possession-fill { height: 100%; transition: width .6s ease; }
    .possession-fill.a { background: var(--green-team); }
    .possession-fill.b { background: var(--red-team); }
    .btn-primary { background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: 600; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
    .btn-secondary { background: #374151; }
    .btn-secondary:hover { background: #4b5563; }
    .commentary-line { font-size: 13px; line-height: 1.5; }
    .commentary-line .time { color: #94a3b8; font-family: monospace; }
    .pitch-line { position: absolute; border: 1px solid rgba(255,255,255,0.15); }
    .center-circle { 
      position: absolute; width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.2); 
      border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%,-50%); 
    }
    .penalty-spot { 
      position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; 
    }
    .penalty-spot.a { left: 12%; top: 12%; }
    .penalty-spot.b { right: 12%; top: 12%; }
    .substitution-popup {
      position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 8px 12px; 
      border-radius: 8px; font-size: 12px; pointer-events: none; z-index: 100; opacity: 0;
      transition: opacity .2s; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1);
    }
    .substitution-popup.show { opacity: 1; }
    .tactical-badge {
      position: absolute; top: -8px; right: -8px; font-size: 10px; padding: 2px 5px;
      background: #1f2937; color: #e2e8f0; border-radius: 4px; font-weight: 600;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 min-h-screen">

  <div class="container mx-auto p-4 md:p-6 max-w-7xl">
    <!-- Header -->
    <header class="mb-8 text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-emerald-400 to-teal-500">
        <i class="fas fa-futbol mr-3"></i> Match Simulator Pro
      </h1>
      <p class="text-slate-400 mt-2 text-sm md:text-base">AI-Powered • Real-time Tactics • Full Animations • Pro Commentary</p>
    </header>

    <main class="grid lg:grid-cols-12 gap-6">
      <!-- Team A Panel -->
      <section class="lg:col-span-3">
        <div class="bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border border-slate-800 shadow-2xl team-card">
          <div class="flex items-center justify-between mb-4">
            <input id="teamAName" class="flex-1 bg-transparent border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none transition" 
                   placeholder="Team A" value="Real Team A"/>
            <button id="aiA" class="ml-3 px-4 py-2 rounded-lg bg-gradient-to-r from-emerald-600 to-emerald-700 text-white font-semibold text-sm hover:from-emerald-700 hover:to-emerald-800 transition shadow-md">
              <i class="fas fa-robot mr-1"></i> AI
            </button>
          </div>
          <h3 id="teamATitle" class="text-xl font-bold text-emerald-400 mb-3 flex items-center">
            Real Team A <span id="formationA" class="ml-2 text-xs bg-emerald-900/50 px-2 py-1 rounded">4-3-3</span>
          </h3>
          <div id="players-A" class="space-y-2 max-h-96 overflow-y-auto pr-1"></div>
        </div>
      </section>

      <!-- Center: Pitch + Controls -->
      <section class="lg:col-span-6">
        <div class="bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border border-slate-800 shadow-2xl">
          <!-- Controls -->
          <div class="flex flex-wrap gap-3 mb-5">
            <button id="startBtn" class="flex-1 md:flex-initial px-6 py-3 rounded-xl btn-primary text-white font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <i class="fas fa-play mr-2"></i> Start Match
            </button>
            <button id="pauseBtn" class="px-5 py-3 rounded-xl btn-secondary text-white font-semibold">
              <i class="fas fa-pause"></i>
            </button>
            <button id="ffBtn" class="px-5 py-3 rounded-xl btn-secondary text-white font-semibold">
              <i class="fas fa-forward"></i> +6'
            </button>
            <button id="resetBtn" class="px-5 py-3 rounded-xl bg-rose-600/80 text-white font-semibold hover:bg-rose-700">
              <i class="fas fa-redo"></i>
            </button>
          </div>

          <!-- Score & Time -->
          <div class="bg-slate-800/70 backdrop-blur p-4 rounded-xl mb-5 border border-slate-700">
            <div class="grid grid-cols-3 items-center text-center">
              <div>
                <div id="modalTeamA" class="text-lg font-bold text-emerald-400">Real Team A</div>
                <div class="text-xs text-slate-400">Home</div>
              </div>
              <div>
                <div class="text-3xl font-extrabold" id="scoreDisplay">0 - 0</div>
                <div id="matchTime" class="text-xl font-mono text-amber-400">0'</div>
                <div class="possession-bar mt-2">
                  <div id="possessionFillA" class="possession-fill a" style="width:50%"></div>
                </div>
                <div id="possessionInfo" class="text-xs text-slate-400 mt-1">50% — 50%</div>
              </div>
              <div>
                <div id="modalTeamB" class="text-lg font-bold text-rose-400">Real Team B</div>
                <div class="text-xs text-slate-400">Away</div>
              </div>
            </div>
          </div>

          <!-- Pitch -->
          <div class="pitch h-80 md:h-96 rounded-xl relative" id="pitch">
            <div class="pitch-line" style="left:0;right:0;top:50%;border-top-style:dashed;"></div>
            <div class="pitch-line" style="left:16.7%;right:16.7%;top:0;bottom:0;border-left-style:dashed;border-right-style:dashed;"></div>
            <div class="center-circle"></div>
            <div class="penalty-spot a"></div>
            <div class="penalty-spot b"></div>
            <div id="ball" class="ball absolute rounded-full" style="left:50%;top:50%;transform:translate(-50%,-50%)"></div>
            <div id="goalFlashHolder" class="absolute top-4 left-1/2 -translate-x-1/2"></div>
          </div>

          <!-- Stats Row -->
          <div class="grid grid-cols-3 gap-3 mt-4 text-center">
            <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
              <div class="text-xs text-slate-400">Fouls</div>
              <div class="text-xl font-bold"><span id="mA-fouls">0</span> - <span id="mB-fouls">0</span></div>
            </div>
            <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
              <div class="text-xs text-slate-400">Yellow Cards</div>
              <div class="text-xl font-bold"><span id="mA-y">0</span> - <span id="mB-y">0</span></div>
            </div>
            <div class="bg-slate-800/60 p-3 rounded-lg border border-slate-700">
              <div class="text-xs text-slate-400">Red Cards</div>
              <div class="text-xl font-bold"><span id="mA-r">0</span> - <span id="mB-r">0</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Team B + Events -->
      <section class="lg:col-span-3">
        <div class="bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border border-slate-800 shadow-2xl team-card">
          <div class="flex items-center justify-between mb-4">
            <input id="teamBName" class="flex-1 bg-transparent border border-slate-700 rounded-lg px-3 py-2 text-sm focus:border-rose-500 focus:outline-none transition" 
                   placeholder="Team B" value="Real Team B"/>
            <button id="aiB" class="ml-3 px-4 py-2 rounded-lg bg-gradient-to-r from-rose-600 to-rose-700 text-white font-semibold text-sm hover:from-rose-700 hover:to-rose-800 transition shadow-md">
              <i class="fas fa-robot mr-1"></i> AI
            </button>
          </div>
          <h3 id="teamBTitle" class="text-xl font-bold text-rose-400 mb-3 flex items-center">
            Real Team B <span id="formationB" class="ml-2 text-xs bg-rose-900/50 px-2 py-1 rounded">4-3-3</span>
          </h3>
          <div id="players-B" class="space-y-2 max-h-64 overflow-y-auto pr-1 mb-5"></div>

          <div class="text-xs font-semibold text-slate-400 mb-2 flex items-center">
            <i class="fas fa-list-ul mr-2"></i> Event Timeline
          </div>
          <div id="eventLog" class="bg-slate-800/50 p-3 rounded-lg h-56 overflow-y-auto text-xs font-mono border border-slate-700"></div>
        </div>
      </section>
    </main>

    <!-- Commentary -->
    <section class="mt-8 bg-slate-900/80 backdrop-blur-xl p-5 rounded-2xl border border-slate-800 shadow-2xl">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-xl font-bold flex items-center"><i class="fas fa-microphone mr-2 text-amber-400"></i> Live Commentary</h4>
        <div class="text-xs text-slate-400">Powered by Pro AI Engine</div>
      </div>
      <div id="modalCommentary" class="h-48 overflow-y-auto pr-2 space-y-1 commentary-line text-sm"></div>
    </section>

    <!-- Substitution Popup -->
    <div id="subPopup" class="substitution-popup">
      <div id="subText"></div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center loading-overlay">
      <div class="bg-slate-900/95 p-8 rounded-2xl text-center border border-slate-700 shadow-2xl">
        <div class="w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <div id="loadingText" class="text-lg font-semibold text-emerald-400">Preparing Match...</div>
        <div id="countdown" class="text-4xl font-bold text-white mt-3">5</div>
      </div>
    </div>
  </div>

<script>
/* ==================== CONFIG & DATA ==================== */
const STARTERS = 11, SUBS = 5;
const ABILITIES = ['Shooting','Passing','Pace','Physical','Dribbling','Defending','Vision'];
const POSITIONS = ['GK','LB','CB','RB','CDM','CM','CAM','LW','RW','ST','CF'];
const FORMATIONS = {
  '4-3-3': [1,4,3,3],
  '4-4-2': [1,4,4,2],
  '4-2-3-1': [1,4,2,3,1],
  '3-5-2': [1,3,5,2],
  '5-3-2': [1,5,3,2]
};

const PRO_POOL = [
  "C. Ronaldo","L. Messi","K. Mbappé","E. Haaland","K. De Bruyne","Neymar Jr","V. Júnior","M. Salah",
  "K. Benzema","R. Lewandowski","H. Kane","B. Silva","J. Kimmich","T. Müller","P. Foden","J. Grealish",
  "R. Sterling","F. Valverde","B. Fernandes","Casemiro","Virgil van Dijk","T. Alexander-Arnold",
  "Rúben Dias","João Cancelo","A. Robertson","S. Ramos","Thiago Silva","Marquinhos","E. Martínez",
  "M. ter Stegen","G. Donnarumma","A. Becker","Ederson","K. Trippier","Pedri","Gavi","Rodri",
  "T. Kroos","L. Modrić","J. Bellingham","M. Ødegaard","N. Kanté","B. Guimarães","D. Rice",
  "E. Fernández","M. Reus","I. Gündoğan","P. Dybala","J. Félix","G. Jesus","Rashford","Sancho",
  "O. Dembélé","L. Martínez","O. Giroud","Antony","L. Díaz","D. Núñez","F. Chiesa","R. Leão",
  "A. Fati","T. Werner","S. Mané","L. Jović","Á. Di María","P. Pogba","M. Depay","C. Eriksen",
  "Z. Ibrahimović","Coutinho","M. Özil","E. Hazard","G. Bale","S. Busquets","G. Chiellini","L. Bonucci"
];

/* ==================== ELEMENTS ==================== */
const els = {
  teamAName: document.getElementById('teamAName'),
  teamBName: document.getElementById('teamBName'),
  aiA: document.getElementById('aiA'),
  aiB: document.getElementById('aiB'),
  playersA: document.getElementById('players-A'),
  playersB: document.getElementById('players-B'),
  startBtn: document.getElementById('startBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  ffBtn: document.getElementById('ffBtn'),
  resetBtn: document.getElementById('resetBtn'),
  loadingOverlay: document.getElementById('loadingOverlay'),
  countdown: document.getElementById('countdown'),
  loadingText: document.getElementById('loadingText'),
  modalTeamA: document.getElementById('modalTeamA'),
  modalTeamB: document.getElementById('modalTeamB'),
  scoreDisplay: document.getElementById('scoreDisplay'),
  matchTime: document.getElementById('matchTime'),
  eventLog: document.getElementById('eventLog'),
  commentary: document.getElementById('modalCommentary'),
  possessionInfo: document.getElementById('possessionInfo'),
  possessionFillA: document.getElementById('possessionFillA'),
  mA_fouls: document.getElementById('mA-fouls'), mB_fouls: document.getElementById('mB-fouls'),
  mA_y: document.getElementById('mA-y'), mB_y: document.getElementById('mB-y'),
  mA_r: document.getElementById('mA-r'), mB_r: document.getElementById('mB-r'),
  goalFlash: document.getElementById('goalFlashHolder'),
  ball: document.getElementById('ball'),
  pitch: document.getElementById('pitch'),
  subPopup: document.getElementById('subPopup'),
  subText: document.getElementById('subText'),
  formationA: document.getElementById('formationA'),
  formationB: document.getElementById('formationB'),
  teamATitle: document.getElementById('teamATitle'),
  teamBTitle: document.getElementById('teamBTitle')
};

/* ==================== STATE ==================== */
let state = {
  A: { name: 'Team A', formation: '4-3-3', players: [], counters: {f:0,y:0,r:0}, subsUsed: 0 },
  B: { name: 'Team B', formation: '4-3-3', players: [], counters: {f:0,y:0,r:0}, subsUsed: 0 },
  sim: {
    running: false, minute: 0, total: 90, extra: 5, score: [0,0], possession: 50,
    interval: null, tickMs: 850, minGoalApplied: false, phase: 'first-half', paused: false
  },
  aiMode: { A: false, B: false }
};

/* ==================== HELPERS ==================== */
const rand = (arr) => arr[Math.floor(Math.random()*arr.length)];
const shuffle = (a) => { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; };
const uniqueName = (set) => { let n; do { n = rand(PRO_POOL) + (Math.random()<0.1?' '+ (10+Math.floor(Math.random()*80)):''); } while(set.has(n)); return n; };
const wait = (ms) => new Promise(r=>setTimeout(r,ms));
const formatTime = (m) => `${Math.min(m,95)}'${m>90?`+${m-90}`:''}`;

/* ==================== PLAYER & TEAM GEN ==================== */
function generatePlayer(name, pos, sub=false) {
  const abilities = shuffle([...ABILITIES]).slice(0, sub?2:3);
  return { name, position: pos, abilities, isSub: sub, sentOff: false, injured: false, rating: 0 };
}

function generateTeam(teamId, displayName, formation = '4-3-3') {
  const used = new Set();
  const slots = FORMATIONS[formation];
  const starters = [];
  let idx = 0;

  // Force stars
  if (teamId === 'A') { starters.push(generatePlayer("C. Ronaldo", "CF")); used.add("C. Ronaldo"); idx++; }
  if (teamId === 'B') { 
    const midIdx = slots[2] > 0 ? slots[1] + Math.floor(slots[2]/2) : STARTERS-1;
    starters[midIdx] = generatePlayer("L. Messi", "CAM"); used.add("L. Messi");
  }

  // Fill GK
  if (!starters[0]) starters[0] = generatePlayer(uniqueName(used), "GK"); used.add(starters[0].name);

  // Fill by position groups
  const posMap = {1:'DEF',2:'MID',3:'ATT'};
  ['DEF','MID','ATT'].forEach((group, gIdx) => {
    const count = slots[gIdx+1];
    for(let i=0; i<count; i++) {
      while(starters[idx]) idx++;
      const pos = group === 'DEF' ? rand(['LB','CB','CB','RB']) :
                  group === 'MID' ? rand(['CDM','CM','CM','CAM']) :
                  rand(['LW','ST','RW','CF']);
      starters[idx++] = generatePlayer(uniqueName(used), pos);
      used.add(starters[idx-1].name);
    }
  });

  // Subs
  const subs = [];
  for(let s=0; s<SUBS; s++) {
    const pos = rand(['GK','DEF','MID','ATT']);
    const posStr = pos==='ATT'?rand(['ST','LW','RW']):pos==='MID'?rand(['CM','CDM']):pos==='DEF'?rand(['CB','LB']):'GK';
    subs.push(generatePlayer(uniqueName(used), posStr, true));
    used.add(subs[s].name);
  }

  const all = starters.concat(subs);
  state[teamId].name = displayName;
  state[teamId].formation = formation;
  state[teamId].players = all;
  renderTeam(teamId);
  checkReady();
}

function renderTeam(teamId) {
  const cont = teamId==='A'?els.playersA:els.playersB;
  cont.innerHTML = '';
  const team = state[teamId];
  const title = teamId==='A'?els.teamATitle:els.teamBTitle;
  title.textContent = team.name;

  team.players.forEach((p, i) => {
    const isSub = i >= STARTERS;
    const row = document.createElement('div');
    row.className = `flex items-center justify-between p-3 rounded-lg border ${isSub?'bg-slate-800/50 border-slate-700':'bg-slate-800/80 border-slate-600'} ${p.sentOff?'opacity-50':''}`;
    const short = p.name.split(' ').pop();
    row.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full ${teamId==='A'?'bg-emerald-600/30':'bg-rose-600/30'} flex items-center justify-center text-xs font-bold">
          ${short[0]}
        </div>
        <div>
          <div class="text-sm font-semibold ${p.sentOff?'line-through':''}">${p.name}</div>
          <div class="text-xs text-slate-400">${p.position} • ${p.abilities.join(' • ')}</div>
        </div>
      </div>
      <div class="text-xs ${isSub?'text-amber-400':'text-emerald-400'}">${isSub?'Sub':p.position}</div>
    `;
    cont.appendChild(row);
  });
}

/* ==================== AI BUTTONS ==================== */
els.aiA.addEventListener('click', () => {
  state.aiMode.A = !state.aiMode.A;
  els.aiA.classList.toggle('ring-2', state.aiMode.A);
  els.aiA.classList.toggle('ring-emerald-500', state.aiMode.A);
  if (state.aiMode.A) generateTeam('A', els.teamAName.value || 'Real Team A', rand(Object.keys(FORMATIONS)));
});
els.aiB.addEventListener('click', () => {
  state.aiMode.B = !state.aiMode.B;
  els.aiB.classList.toggle('ring-2', state.aiMode.B);
  els.aiB.classList.toggle('ring-rose-500', state.aiMode.B);
  if (state.aiMode.B) generateTeam('B', els.teamBName.value || 'Real Team B', rand(Object.keys(FORMATIONS)));
});

els.teamAName.addEventListener('input', () => { if(state.aiMode.A) generateTeam('A', els.teamAName.value); });
els.teamBName.addEventListener('input', () => { if(state.aiMode.B) generateTeam('B', els.teamBName.value); });

/* ==================== START CHECK ==================== */
function checkReady() {
  const ready = state.A.players.length >= STARTERS+SUBS && state.B.players.length >= STARTERS+SUBS && state.aiMode.A && state.aiMode.B;
  els.startBtn.disabled = !ready;
}

/* ==================== MATCH START ==================== */
els.startBtn.addEventListener('click', async () => {
  state.A.name = els.teamAName.value || state.A.name;
  state.B.name = els.teamBName.value || state.B.name;
  els.loadingOverlay.classList.remove('hidden');
  els.loadingText.textContent = 'Finalizing lineups & tactics...';

  for(let i=5; i>=0; i--) {
    els.countdown.textContent = i;
    await wait(1000);
  }

  els.loadingText.textContent = 'Kick-off!';
  await wait(800);
  els.loadingOverlay.classList.add('hidden');

  startMatch();
});

function startMatch() {
  state.sim = {
    running: true, minute: 0, score: [0,0], possession: 50, interval: null,
    tickMs: 850, minGoalApplied: false, phase: 'first-half', paused: false
  };
  els.scoreDisplay.textContent = '0 - 0';
  els.matchTime.textContent = "0'";
  els.eventLog.innerHTML = '';
  els.commentary.innerHTML = '';
  Object.keys(state.A.counters).forEach(k=>state.A.counters[k]=0);
  Object.keys(state.B.counters).forEach(k=>state.B.counters[k]=0);
  updateCounters();

  drawPitch();
  els.pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';

  state.sim.interval = setInterval(() => {
    if (!state.sim.running || state.sim.paused) return;
    state.sim.minute++;
    updateUI();
    simulateMinute(state.sim.minute);

    if (state.sim.minute >= 95) {
      clearInterval(state.sim.interval);
      endMatch();
    }
  }, state.sim.tickMs);
}

/* ==================== SIMULATION ==================== */
async function simulateMinute(min) {
  const possA = state.sim.possession = Math.max(30, Math.min(70, state.sim.possession + (Math.random()*6 - 3)));
  updatePossession();

  const attackRoll = Math.random();
  const threshA = 0.48 + (possA-50)/180;
  const threshB = 0.48 + (100-possA-50)/180;

  if (attackRoll < threshA) await resolveAttack('A', min);
  else if (attackRoll > 1-threshB) await resolveAttack('B', min);
  else commentary(`${min}' — Tactical battle in midfield. Both teams patient.`);

  // Fouls & cards
  if (Math.random() < 0.07) await handleFoul(min);

  // Substitutions
  if (min > 60 && min % 12 === 0 && Math.random() < 0.4) await makeSubstitution(min);

  // Injury
  if (Math.random() < 0.008) await handleInjury(min);

  // Min goals
  if (!state.sim.minGoalApplied && min > 70 && state.sim.score[0] + state.sim.score[1] < 2) {
    state.sim.minGoalApplied = true;
    setTimeout(() => forceGoal(state.sim.possession >= 50 ? 'A' : 'B', min+2), 1500);
  }
}

async function resolveAttack(team, min) {
  const attacker = pickStarter(team);
  const defender = pickStarter(team==='A'?'B':'A');
  commentary(`${min}' — ${attacker} surges forward with intent!`);

  await wait(600);

  const shot = Math.random();
  if (shot < 0.28) {
    goal(team, attacker, min);
  } else if (shot < 0.58) {
    commentary(`${min}' — ${attacker}'s effort is saved! Outstanding stop.`);
    moveBall(team==='A'?65:35, 50);
  } else if (shot < 0.78) {
    commentary(`${min}' — ${defender} throws body on the line! Blocked.`);
    moveBall(team==='A'?58:42, 50);
  } else {
    commentary(`${min}' — Off target. Goal kick.`);
    moveBall(team==='A'?85:15, 50);
  }
}

function goal(team, scorer, min) {
  const idx = team==='A'?0:1;
  state.sim.score[idx]++;
  els.scoreDisplay.textContent = `${state.sim.score[0]} - ${state.sim.score[1]}`;
  event(`GOAL! ${scorer} (${state[team].name}) — ${min}'`);
  flashGoal(`${scorer} ${min}'`);
  moveBall(50,50);
  setTimeout(() => commentary(`WHAT A STRIKE! ${scorer} breaks the deadlock!`), 300);
}

async function handleFoul(min) {
  const team = Math.random()<0.5?'A':'B';
  const player = pickStarter(team);
  state[team].counters.f++;
  updateCounters();
  event(`${player} fouls — ${min}'`);

  if (Math.random() < 0.32) {
    state[team].counters.y++;
    updateCounters();
    event(`Yellow Card → ${player}`);
    showCard(team, 'yellow');

    if (Math.random() < 0.06) {
      state[team].counters.r++;
      updateCounters();
      event(`RED CARD! ${player} is off!`);
      showCard(team, 'red');
      state[team].players.find(p=>p.name===player).sentOff = true;
      drawPitch();
    }
  }

  if (Math.random() < 0.22) {
    const winner = team==='A'?'B':'A';
    event(`PENALTY to ${state[winner].name}!`);
    await wait(800);
    const taker = choosePenaltyTaker(winner);
    if (Math.random() < 0.78) {
      goal(winner, taker, min);
      event(`PENALTY SCORED! ${taker}`);
    } else {
      event(`PENALTY MISSED! ${taker}`);
    }
  }
}

async function makeSubstitution(min) {
  const team = Math.random()<0.5?'A':'B';
  if (state[team].subsUsed >= 5) return;
  const starters = state[team].players.slice(0,STARTERS).filter(p=>!p.sentOff && !p.injured);
  const subs = state[team].players.slice(STARTERS).filter(p=>!p.used);
  if (!starters.length || !subs.length) return;

  const outP = rand(starters);
  const inP = rand(subs);
  inP.used = true;
  state[team].subsUsed++;

  showSubPopup(outP.name, inP.name, team);
  event(`SUB: ${inP.name} → ${outP.name} (${state[team].name})`);
  await wait(1500);
  els.subPopup.classList.remove('show');
  drawPitch();
}

function handleInjury(min) {
  const team = Math.random()<0.5?'A':'B';
  const player = pickStarter(team);
  state[team].players.find(p=>p.name===player).injured = true;
  event(`INJURY: ${player} down — ${min}'`);
  setTimeout(() => makeSubstitution(min+1), 2000);
}

/* ==================== UI UPDATES ==================== */
function updateUI() {
  els.matchTime.textContent = formatTime(state.sim.minute);
  updatePossession();
}

function updatePossession() {
  const p = state.sim.possession;
  els.possessionInfo.textContent = `${p.toFixed(0)}% — ${(100-p).toFixed(0)}%`;
  els.possessionFillA.style.width = `${p}%`;
}

function updateCounters() {
  ['f','y','r'].forEach(k => {
    els[`mA_${k}`].textContent = state.A.counters[k];
    els[`mB_${k}`].textContent = state.B.counters[k];
  });
}

function showCard(team, type) {
  const target = team==='A'?els.modalTeamA:els.modalTeamB;
  const badge = document.createElement('span');
  badge.className = 'stat-badge ml-2';
  badge.innerHTML = type==='yellow'?'Y':'R';
  badge.style.background = type==='yellow'?'#f59e0b':'#ef4444';
  badge.style.color = 'white';
  target.appendChild(badge);
  setTimeout(() => badge.remove(), 8000);
}

function showSubPopup(out, inn, team) {
  els.subText.innerHTML = `<i class="fas fa-arrow-up text-red-400"></i> ${out}<br><i class="fas fa-arrow-down text-emerald-400"></i> ${inn}`;
  els.subPopup.classList.add('show');
  setTimeout(() => els.subPopup.classList.remove('show'), 3000);
}

function flashGoal(text) {
  const el = document.createElement('div');
  el.className = 'goal-flash';
  el.textContent = text;
  els.goalFlash.innerHTML = '';
  els.goalFlash.appendChild(el);
  setTimeout(() => els.goalFlash.innerHTML = '', 2500);
}

function event(msg) {
  const div = document.createElement('div');
  div.className = 'event-item new';
  div.textContent = msg;
  els.eventLog.prepend(div);
  setTimeout(() => div.classList.remove('new'), 100);
}

function commentary(msg) {
  const div = document.createElement('div');
  div.className = 'commentary-line';
  const now = new Date();
  div.innerHTML = `<span class="time">[${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}]</span> ${msg}`;
  els.commentary.prepend(div);
}

/* ==================== PITCH & BALL ==================== */
function drawPitch() {
  els.pitch.innerHTML = `
    <div class="pitch-line" style="left:0;right:0;top:50%;border-top-style:dashed;"></div>
    <div class="pitch-line" style="left:16.7%;right:16.7%;top:0;bottom:0;border-left-style:dashed;border-right-style:dashed;"></div>
    <div class="center-circle"></div>
    <div class="penalty-spot a"></div>
    <div class="penalty-spot b"></div>
  `;
  const posA = getFormationPositions('A');
  const posB = getFormationPositions('B');

  state.A.players.slice(0,STARTERS).forEach((p,i) => {
    if (p.sentOff || p.injured) return;
    els.pitch.appendChild(createPlayer(p, 'A', posA[i]));
  });
  state.B.players.slice(0,STARTERS).forEach((p,i) => {
    if (p.sentOff || p.injured) return;
    els.pitch.appendChild(createPlayer(p, 'B', posB[i]));
  });

  setBall(50,50);
  enableDrag();
}

function getFormationPositions(team) {
  const base = team==='A' ? 15 : 85;
  const slots = FORMATIONS[state[team].formation];
  const pos = [];
  let y = 88, idx = 0;
  pos.push({x: base, y}); // GK

  slots.slice(1).forEach((count, group) => {
    y -= 18;
    const spread = count * 10;
    const start = base - spread/2;
    for(let i=0; i<count; i++) {
      pos.push({x: start + i*10 + 5, y: y + (Math.random()*6-3)});
    }
  });
  return pos;
}

function createPlayer(p, team, pos) {
  const el = document.createElement('div');
  el.className = `player-pill team-${team} absolute`;
  el.style.left = pos.x + '%';
  el.style.top = pos.y + '%';
  el.innerHTML = `<span>${p.name.split(' ')[0]}</span><div class="tactical-badge">${p.position}</div>`;
  el.dataset.name = p.name;
  return el;
}

function setBall(x,y) {
  els.ball.style.left = x + '%';
  els.ball.style.top = y + '%';
}

function moveBall(x,y) {
  const steps = 15;
  const startX = parseFloat(els.ball.style.left);
  const startY = parseFloat(els.ball.style.top);
  let step = 0;
  const dx = (x - startX)/steps;
  const dy = (y - startY)/steps;
  const anim = setInterval(() => {
    step++;
    setBall(startX + dx*step, startY + dy*step);
    if (step >= steps) clearInterval(anim);
  }, 35);
}

function enableDrag() {
  let drag = null;
  els.pitch.addEventListener('pointerdown', e => {
    const pill = e.target.closest('.player-pill');
    if (!pill || !state.sim.running) return;
    drag = pill;
    pill.setPointerCapture(e.pointerId);
  });
  els.pitch.addEventListener('pointermove', e => {
    if (!drag) return;
    const rect = els.pitch.getBoundingClientRect();
    let x = (e.clientX - rect.left) / rect.width * 100;
    let y = (e.clientY - rect.top) / rect.height * 100;
    x = Math.max(5, Math.min(95, x));
    y = Math.max(5, Math.min(95, y));
    drag.style.left = x + '%';
    drag.style.top = y + '%';
  });
  els.pitch.addEventListener('pointerup', () => { drag = null; });
}

/* ==================== UTILS ==================== */
function pickStarter(team) {
  const starters = state[team].players.slice(0,STARTERS).filter(p=>!p.sentOff && !p.injured);
  return starters.length ? rand(starters).name : 'Player';
}

function choosePenaltyTaker(team) {
  const shooters = state[team].players.filter(p=>p.abilities.includes('Shooting') && !p.isSub && !p.sentOff);
  return shooters.length ? rand(shooters).name : pickStarter(team);
}

function forceGoal(team, min) {
  const scorer = pickStarter(team);
  goal(team, scorer, min);
}

/* ==================== END MATCH ==================== */
async function endMatch() {
  event(`FULL TIME: ${state.A.name} ${state.sim.score[0]} - ${state.sim.score[1]} ${state.B.name}`);
  if (state.sim.score[0] === state.sim.score[1]) {
    commentary("It's all square! We go to penalties...");
    await wait(2000);
    await penalties();
  } else {
    const winner = state.sim.score[0] > state.sim.score[1] ? state.A.name : state.B.name;
    flashGoal(`${winner} WINS!`);
    event(`${winner} are the champions!`);
  }
  state.sim.running = false;
}

async function penalties() {
  let a=0, b=0;
  const takersA = state.A.players.slice(0,5).map(p=>p.name);
  const takersB = state.B.players.slice(0,5).map(p=>p.name);

  for(let i=0; i<5; i++) {
    if (Math.random() < 0.76) { a++; event(`GOAL! ${takersA[i]}`); flashGoal(`${takersA[i]} (pen)`); }
    else event(`MISS! ${takersA[i]}`);
    await wait(800);

    if (Math.random() < 0.76) { b++; event(`GOAL! ${takersB[i]}`); flashGoal(`${takersB[i]} (pen)`); }
    else event(`MISS! ${takersB[i]}`);
    await wait(800);

    if (a > b + (5-i) || b > a + (5-i)) break;
  }

  while(a === b) {
    const sA = Math.random() < 0.73; const sB = Math.random() < 0.73;
    if (sA) a++; else event(`SUDDEN DEATH MISS!`);
    await wait(700);
    if (sB) b++; else event(`SUDDEN DEATH MISS!`);
    await wait(700);
  }

  const winner = a>b ? state.A.name : state.B.name;
  event(`PENS: ${a}-${b} — ${winner} WIN ON PENALTIES!`);
  flashGoal(`${winner} CHAMPIONS!`);
}

/* ==================== CONTROLS ==================== */
els.pauseBtn.addEventListener('click', () => {
  state.sim.paused = !state.sim.paused;
  els.pauseBtn.innerHTML = state.sim.paused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
});
els.ffBtn.addEventListener('click', () => {
  state.sim.minute += 6;
  updateUI();
});
els.resetBtn.addEventListener('click', () => {
  if (state.sim.interval) clearInterval(state.sim.interval);
  generateTeam('A', 'Real Team A');
  generateTeam('B', 'Real Team B');
  state.sim.running = false;
});

/* ==================== INIT ==================== */
generateTeam('A', 'Real Team A');
generateTeam('B', 'Real Team B');
setInterval(() => { if(state.sim.running && !state.sim.paused) moveBall(50 + (state.sim.possession-50)*0.6, 40 + Math.random()*30); }, 1500);
</script>
</body>
</html>
